<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IEMM - الفواتير</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../views/css/styles.css" />
    <link rel="stylesheet" href="../views/css/malls-dashbboard/mall.css" />
    <link rel="stylesheet" href="../views/css/chat.css" />
    <script src="../views/assets/jquery-3.7.1.min.js"></script>
    <script src="../views/js/script.js" defer></script>
    <script src="../views/js/MallManagerChat.js" defer></script>
    <script src="../views/js/theme-manager.js" defer></script>
    <script src="../views/js/mall-management/malls-bills.js" defer></script>
    <!-- إضافة مكتبة Font Awesome للأيقونات -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* تنسيقات الوضع الليلي للفواتير */
      body.dark .table.card {
        background: var(--dark-card);
        border-color: var(--dark-chart);
      }

      body.dark .table-header {
        background: var(--dark-bg);
        border-color: var(--dark-chart);
      }

      body.dark .table-header h3 {
        color: var(--dark-text);
      }

      body.dark .filter-controls {
        background: var(--dark-bg);
        border-color: var(--dark-chart);
      }

      body.dark .search-input {
        background: var(--dark-bg);
        color: var(--dark-text);
        border-color: var(--dark-chart);
      }

      body.dark .search-input:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
      }

      body.dark .search-icon {
        color: var(--dark-text);
      }

      body.dark .table-wrapper {
        background: var(--dark-card);
      }

      body.dark .table-wrapper table {
        background: var(--dark-card);
      }

      body.dark .table-wrapper th {
        background: var(--dark-bg);
        color: var(--dark-text);
        border-bottom-color: var(--dark-chart);
      }

      body.dark .table-wrapper td {
        color: var(--dark-text);
        border-bottom-color: var(--dark-chart);
      }

      body.dark .table-wrapper tr:hover {
        background: var(--dark-bg);
      }

      /* تنسيقات أيقونات الجدول */
      body.dark .table-wrapper .btn-icon {
        background: var(--dark-bg);
        color: var(--dark-text);
        border: 1px solid var(--dark-chart);
        transition: all 0.3s ease;
      }

      body.dark .table-wrapper .btn-icon:hover {
        background: var(--dark-chart);
        color: var(--primary-green);
        border-color: var(--primary-green);
      }

      body.dark .table-wrapper .btn-icon .fa-eye {
        color: var(--dark-text);
      }

      body.dark .table-wrapper .btn-icon:hover .fa-eye {
        color: var(--primary-green);
      }

      body.dark .table-wrapper .btn-icon .fa-envelope {
        color: var(--dark-text);
      }

      body.dark .table-wrapper .btn-icon:hover .fa-envelope {
        color: var(--primary-green);
      }

      /* تنسيقات أيقونات التعديل في نافذة عرض البيانات */
      body.dark .bill-section .btn-icon {
        background: var(--dark-bg);
        color: var(--dark-text);
        border: 1px solid var(--dark-chart);
        transition: all 0.3s ease;
      }

      body.dark .bill-section .btn-icon:hover {
        background: var(--dark-chart);
        color: var(--primary-green);
        border-color: var(--primary-green);
      }

      body.dark .bill-section .btn-icon .fa-edit {
        color: var(--dark-text);
      }

      body.dark .bill-section .btn-icon:hover .fa-edit {
        color: var(--primary-green);
      }

      body.dark .bill-section .btn-icon.save-btn {
        background: var(--dark-bg);
        color: var(--dark-text);
        border: 1px solid var(--dark-chart);
      }

      body.dark .bill-section .btn-icon.save-btn:hover {
        background: var(--dark-chart);
        color: var(--primary-green);
        border-color: var(--primary-green);
      }

      body.dark .bill-section .btn-icon.save-btn .fa-save {
        color: var(--dark-text);
      }

      body.dark .bill-section .btn-icon.save-btn:hover .fa-save {
        color: var(--primary-green);
      }

      body.dark .bill-section .btn-icon.cancel-btn {
        background: var(--dark-bg);
        color: var(--dark-text);
        border: 1px solid var(--dark-chart);
      }

      body.dark .bill-section .btn-icon.cancel-btn:hover {
        background: var(--dark-chart);
        color: #ef4444;
        border-color: #ef4444;
      }

      body.dark .bill-section .btn-icon.cancel-btn .fa-times {
        color: var(--dark-text);
      }

      body.dark .bill-section .btn-icon.cancel-btn:hover .fa-times {
        color: #ef4444;
      }

      /* تنسيقات إضافية للجدول والنوافذ المنبثقة */
      body.dark .filter-row {
        background: var(--dark-bg) !important;
      }

      body.dark .filter-row td {
        border-bottom-color: var(--dark-chart);
      }

      body.dark .table-filter-input {
        background: var(--dark-card) !important;
        color: var(--dark-text) !important;
        border-color: var(--dark-chart) !important;
      }

      body.dark .table-filter-input:focus {
        border-color: var(--primary-green) !important;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1) !important;
      }

      body.dark .table-filter-input:hover {
        border-color: var(--dark-text) !important;
        background: var(--dark-bg) !important;
      }

      body.dark .table-filter-input option {
        background: var(--dark-card);
        color: var(--dark-text);
      }

      body.dark .modal {
        background-color: rgba(0, 0, 0, 0.7);
      }

      body.dark .modal-content {
        background: var(--dark-card);
        border-color: var(--dark-chart);
      }

      body.dark .modal-header {
        border-bottom-color: var(--dark-chart);
      }

      body.dark .modal-header h3 {
        color: var(--dark-text);
      }

      body.dark .btn-close {
        color: var(--dark-text);
      }

      body.dark .btn-close:hover {
        color: #ef4444;
      }

      body.dark .form-group label {
        color: var(--dark-text);
      }

      body.dark .form-group textarea {
        background: var(--dark-bg);
        color: var(--dark-text);
        border-color: var(--dark-chart);
      }

      body.dark .form-group textarea:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
      }

      body.dark .bill-section {
        background: var(--dark-card);
        border-color: var(--dark-chart);
      }

      body.dark .bill-section.editing {
        background: var(--dark-bg);
        border-color: var(--primary-green);
      }

      body.dark .detail-row {
        background: var(--dark-bg);
      }

      body.dark .detail-row:hover {
        background: var(--dark-chart);
      }

      body.dark .detail-label {
        color: var(--dark-text);
      }

      body.dark .detail-value {
        color: var(--dark-text);
      }

      body.dark .detail-row.total {
        background: var(--dark-bg);
        border-color: var(--dark-chart);
      }

      body.dark .detail-row.total:hover {
        background: var(--dark-chart);
      }

      body.dark .detail-row.grand-total {
        background: var(--primary-green);
        color: var(--dark-text);
      }

      body.dark .detail-row.grand-total:hover {
        background: #16a34a;
      }

      body.dark .section-header h4 {
        color: var(--dark-text);
      }

      body.dark .edit-input {
        background: var(--dark-bg);
        color: var(--dark-text);
        border-color: var(--dark-chart);
      }

      body.dark .edit-input:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
      }

      /* تنسيقات الطباعة */
      @media print {
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          color: #333;
        }

        .invoice-print {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
        }

        .invoice-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid #eee;
        }

        .mall-info {
          text-align: right;
        }

        .mall-info h1 {
          margin: 0 0 10px 0;
          color: #1e40af;
          font-size: 24px;
        }

        .mall-info p {
          margin: 5px 0;
          color: #666;
          font-size: 14px;
        }

        .invoice-info {
          text-align: left;
        }

        .invoice-info h2 {
          margin: 0 0 15px 0;
          color: #1e40af;
          font-size: 20px;
        }

        .info-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .info-item {
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .info-item .label {
          font-size: 12px;
          color: #666;
        }

        .info-item .value {
          font-size: 14px;
          font-weight: bold;
          color: #333;
        }

        .bill-details-table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }

        .bill-details-table th,
        .bill-details-table td {
          padding: 10px;
          text-align: right;
          border: 1px solid #ddd;
          font-size: 14px;
        }

        .bill-details-table th {
          background-color: #f8fafc;
          font-weight: bold;
          color: #1e40af;
        }

        .bill-details-table tr:nth-child(even) {
          background-color: #f8fafc;
        }

        .invoice-summary {
          margin-top: 20px;
          padding: 15px;
          background-color: #f8fafc;
          border-radius: 8px;
        }

        .summary-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .summary-item {
          display: flex;
          justify-content: space-between;
          padding: 8px;
          border-bottom: 1px solid #eee;
        }

        .summary-item.total {
          grid-column: 1 / -1;
          background-color: #1e40af;
          color: white;
          border-radius: 4px;
          margin-top: 10px;
          padding: 12px;
        }

        .summary-item.total .label,
        .summary-item.total .value {
          color: white;
          font-weight: bold;
        }

        .invoice-footer {
          margin-top: 30px;
          text-align: center;
          padding-top: 20px;
          border-top: 2px solid #eee;
        }

        .invoice-footer p {
          margin: 5px 0;
          color: #666;
          font-size: 14px;
        }

        @page {
          size: A4;
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <script>
      // Check authorization before loading the page
      function checkAuthorization() {
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('user_type');
        
        // Check if token exists
        if (!token) {
          window.location.href = '../login.html';
          return;
        }

        // Check user type (admin = 4)
        if (userType !== '1') {
          // Create and show unauthorized message
          document.body.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100vh;
              background-color: #f8fafc;
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <i class="fas fa-exclamation-triangle" style="
                font-size: 64px;
                color: #ef4444;
                margin-bottom: 20px;
              "></i>
              <h1 style="
                color: #1e293b;
                font-size: 24px;
                margin-bottom: 16px;
              ">غير مصرح لك بالوصول</h1>
              <p style="
                color: #64748b;
                font-size: 16px;
                margin-bottom: 24px;
              ">عذراً، ليس لديك الصلاحية للوصول إلى هذه الصفحة</p>
              <button onclick="window.location.href='../login.html'" style="
                background-color: #2563eb;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                transition: background-color 0.3s;
              ">العودة إلى صفحة تسجيل الدخول</button>
            </div>
          `;
          return;
        }

        // Verify token with backend
        
      }

      // Run authorization check when page loads
      $(document).ready(function() {
        checkAuthorization();
      });
    </script>
    <!-- Header Section -->
    <header>
      <div class="container navbar">
        <h1>IEMM</h1>
        <nav>
          <a href="mall-dashboard.html" id="dashboard-link"
            ><i class="fas fa-chart-line"></i> لوحة التحكم</a
          >
          <a href="stores-management.html" id="stores-link"
            ><i class="fas fa-store"></i> إدارة المحلات</a
          >
          <a href="bills.html" id="bills-link" class="active"
            ><i class="fas fa-file-invoice-dollar"></i> الفواتير</a
          >
        </nav>
        <div style="display: flex; align-items: center; gap: 12px">
          <button class="btn-dark convert"></button>
          <!-- <button class="btn-dark " onclick="document.body.classList.toggle('dark')">الوضع الليلي</button> -->
          <button
            id="chat-toggle"
            class="chat-toggle-btn"
            title="الدردشة مع أصحاب المحلات"
          >
            <i class="fas fa-comments"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- نافذة الدردشة الجانبية -->
    <div id="chat-panel" class="chat-panel">
      <!-- قائمة جهات الاتصال -->
      <div id="contacts-view">
        <div class="chat-header">
          <h3>الدردشة مع أصحاب المحلات</h3>
          <button id="chat-close" class="chat-close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="contact-list" class="contact-list">
          <!-- سيتم إنشاء قائمة جهات الاتصال عبر JavaScript -->
        </div>
      </div>

      <!-- نافذة المحادثة -->
      <div id="chat-conversation" class="chat-conversation">
        <div class="conversation-header">
          <button id="back-to-contacts" class="back-to-contacts">
            <i class="fas fa-arrow-right"></i>
          </button>
          <div class="conversation-contact">
            <div id="conversation-avatar" class="conversation-avatar">أ</div>
            <div class="conversation-info">
              <h4 id="conversation-title">أحمد محمد</h4>
              <p id="conversation-store">مطعم الأصالة</p>
            </div>
          </div>
        </div>
        <div id="messages-container" class="messages-container">
          <!-- سيتم إنشاء الرسائل عبر JavaScript -->
        </div>
        <form id="message-form" class="message-form">
          <textarea
            id="message-input"
            class="message-input"
            placeholder="اكتب رسالتك هنا..."
            rows="1"
          ></textarea>
          <button type="submit" class="send-message-btn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <!-- Bills Section -->
      <div class="section active" id="bills-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-file-invoice-dollar"></i> إدارة الفواتير
          </h2>
        </div>

        <div class="action-buttons" style="margin-bottom: 1rem">
          <button
            class="btn-green"
            onclick="document.getElementById('newInvoiceFormContainer').style.display = document.getElementById('newInvoiceFormContainer').style.display === 'none' ? 'block' : 'none'"
          >
            <i class="fas fa-plus"></i> إنشاء فاتورة جديدة
          </button>
        </div>

        <!-- نموذج إنشاء فاتورة جديدة -->
        <form
          class="form-container"
          id="newInvoiceFormContainer"
          style="display: none"
        >
          <div class="form card">
            <h3>إضافة فاتورة جديدة</h3>
            <div class="form-grid">
              <select name="shop_id" required>
                <option value="">اختر المحل</option>
              </select>
              <input type="number" name="electricity_amount" placeholder="مبلغ فاتورة الكهرباء " required />
              <input type="number" name="water_amount" placeholder="مبلغ فاتورة الماء " required />
              <input type="number" name="rent_amount" placeholder="مبلغ الايجار " required />  
              <input type="date"  name="date" placeholder="تاريخ الإصدار" required />
            </div>
            <button class="btn-green">حفظ</button>
          </div>
        </form>

        <!-- Invoices Table with Integrated Filters -->
        <div class="table card">
          <div class="table-header">
            <div class="filter-controls">
              <div class="filter-group">
                <div class="search-box">
                  <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="بحث في اسم المحل أو صاحب المحل..."
                    oninput="applyFilters()"
                  />
                </div>
              </div>
              <button class="btn-dark" onclick="openBulkMessageModal()">
                <i class="fas fa-bell"></i> إرسال رسالة جماعية
              </button>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>اسم المحل</th>
                  <th>اسم صاحب المحل</th>
                  <th>الكهرباء</th>
                  <th>الماء</th>
                  <th>الإيجار</th>
                  <th>الشهر</th>
                  <th>المتأخرات</th>
                  <th>الإجمالي</th>
                  <th>الإجراءات</th>
                </tr>
                <tr class="filter-row">
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>
                    <select id="filter-month" class="table-filter-input">
                      <option value="all">الكل</option>
                    </select>
                  </td>
                  <td>
                    <select id="filter-overdue" class="table-filter-input">
                      <option value="all">الكل</option>
                      <option value="yes">عليه متأخرات</option>
                      <option value="no">ليس عليه متأخرات</option>
                    </select>
                  </td>
                  <td>
                    <select id="filter-total" class="table-filter-input">
                      <option value="all">الكل</option>
                      <option value="paid">مدفوع</option>
                      <option value="unpaid">غير مدفوع</option>
                    </select>
                  </td>
                  <td></td>
                </tr>
              </thead>
              <tbody class="bills-table">
                <!-- <tr data-invoice-id="1">
                  <td>محل A101</td>
                  <td>أحمد محمد</td>
                  <td>500 ريال</td>
                  <td>200 ريال</td>
                  <td>5,000 ريال</td>
                  <td>فبراير 2024</td>
                  <td>0 ريال</td>
                  <td>5,700 ريال</td>
                  <td>
                    <button
                      class="btn-icon"
                      title="عرض التفاصيل"
                      onclick="viewInvoice(1)"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                    <button
                      class="btn-icon"
                      title="إرسال رسالة"
                      onclick="sendMessage(1)"
                    >
                      <i class="fas fa-envelope"></i>
                    </button>
                  </td>
                </tr> -->
                
              </tbody>
            </table>
          </div>
        </div>

        <!-- Bulk Message Modal -->
        <div id="bulkMessageModal" class="modal">
          <div class="modal-content">
            <h3>إرسال رسالة جماعية</h3>
            <form id="bulkMessageForm" class="form" onsubmit="handleBulkMessage(event)">
              <div class="form-group">
                <label>نص الرسالة</label>
                <textarea id="bulkMessageText" required placeholder="اكتب رسالتك هنا..."></textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-green">إرسال</button>
                <button type="button" class="btn-secondary" onclick="closeBulkMessageModal()">إلغاء</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Invoice Details Modal -->
        <div id="invoiceDetailsModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>تفاصيل الفاتورة</h3>
              <button class="btn-close" onclick="closeModal('invoiceDetailsModal')">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="bill-sections-container">
              <div>
                <div class="bill-section">
                  <div class="section-header">
                    <h4>معلومات المحل</h4>
                    <div class="section-actions">
                      <button class="btn-icon" id="store-info-edit" title="تعديل معلومات المحل" onclick="toggleEditMode('store-info')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-icon" id="store-info-save" title="حفظ التغييرات" onclick="saveEdit('store-info')" style="display: none">
                        <i class="fas fa-save"></i>
                      </button>
                      <button class="btn-icon" id="store-info-cancel" title="إلغاء التعديل" onclick="cancelEdit('store-info')" style="display: none">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="bill-details">
                    <div class="detail-row">
                      <span class="detail-label">اسم المحل</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="shop-name"></span>
                        <input type="text" class="edit-input" id="shop-name-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">اسم صاحب المحل</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="shop-owner-name"></span>
                        <input type="text" class="edit-input" id="shop-owner-name-input" style="display: none" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="bill-section">
                  <div class="section-header">
                    <h4>الإيجار</h4>
                    <div class="section-actions">
                      <button class="btn-icon" id="rent-edit" title="تعديل فاتورة الإيجار" onclick="toggleEditMode('rent')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-icon" id="rent-save" title="حفظ التغييرات" onclick="saveEdit('rent')" style="display: none">
                        <i class="fas fa-save"></i>
                      </button>
                      <button class="btn-icon" id="rent-cancel" title="إلغاء التعديل" onclick="cancelEdit('rent')" style="display: none">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="bill-details">
                    <div class="detail-row">
                      <span class="detail-label">مبلغ الشهر الحالي</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="rent-current"></span>
                        <input type="number" class="edit-input" id="rent-current-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">المتأخرات</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="rent-remaining"></span>
                        <input type="number" class="edit-input" id="rent-remaining-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row total">
                      <span class="detail-label">الإجمالي</span>
                      <span class="detail-value" id="rent-total"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <div class="bill-section">
                  <div class="section-header">
                    <h4>الكهرباء</h4>
                    <div class="section-actions">
                      <button class="btn-icon" id="electricity-edit" title="تعديل فاتورة الكهرباء" onclick="toggleEditMode('electricity')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-icon" id="electricity-save" title="حفظ التغييرات" onclick="saveEdit('electricity')" style="display: none">
                        <i class="fas fa-save"></i>
                      </button>
                      <button class="btn-icon" id="electricity-cancel" title="إلغاء التعديل" onclick="cancelEdit('electricity')" style="display: none">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="bill-details">
                    <div class="detail-row">
                      <span class="detail-label">مبلغ الشهر الحالي</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="electricity-current"></span>
                        <input type="number" class="edit-input" id="electricity-current-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">المتأخرات</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="electricity-remaining"></span>
                        <input type="number" class="edit-input" id="electricity-remaining-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row total">
                      <span class="detail-label">الإجمالي</span>
                      <span class="detail-value" id="electricity-total"></span>
                    </div>
                  </div>
                </div>
                <div class="bill-section">
                  <div class="section-header">
                    <h4>الماء</h4>
                    <div class="section-actions">
                      <button class="btn-icon" id="water-edit" title="تعديل فاتورة الماء" onclick="toggleEditMode('water')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-icon" id="water-save" title="حفظ التغييرات" onclick="saveEdit('water')" style="display: none">
                        <i class="fas fa-save"></i>
                      </button>
                      <button class="btn-icon" id="water-cancel" title="إلغاء التعديل" onclick="cancelEdit('water')" style="display: none">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="bill-details">
                    <div class="detail-row">
                      <span class="detail-label">مبلغ الشهر الحالي</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="water-current"></span>
                        <input type="number" class="edit-input" id="water-current-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">المتأخرات</span>
                      <div class="detail-value-container">
                        <span class="detail-value" id="water-remaining"></span>
                        <input type="number" class="edit-input" id="water-remaining-input" style="display: none" />
                      </div>
                    </div>
                    <div class="detail-row total">
                      <span class="detail-label">الإجمالي</span>
                      <span class="detail-value" id="water-total"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="bill-section total-section">
                <div class="bill-details">
                  <div class="detail-row grand-total">
                    <span class="detail-label">إجمالي الفاتورة</span>
                    <span class="detail-value" id="grand-total"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="bill-actions">
              <button class="btn-green" onclick="downloadPDF()">
                <i class="fas fa-download"></i>
                تحميل PDF
              </button>
              <button class="btn-secondary" onclick="closeModal('invoiceDetailsModal')">
                إغلاق
              </button>
            </div>
          </div>
        </div>

        <style>
          /* تحسين تصميم النافذة المنبثقة */
          .modal-content {
            width: 90vw;
            max-width: 1400px;
            min-width: 350px;
            padding: 2.5rem 3.5rem;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
          }
          .bill-sections-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
          }
          @media (max-width: 1100px) {
            .modal-content {
              padding: 1.2rem 0.5rem;
            }
            .bill-sections-container {
              grid-template-columns: 1fr;
              gap: 2rem;
            }
          }
          .bill-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.2rem 1.5rem 1.5rem 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.3s, background 0.3s;
            min-width: 0;
          }
          .bill-section.editing {
            background: #f0f6ff;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.08);
            border-color: #2563eb;
          }
          .bill-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.1rem 1.5rem;
          }
          .detail-row {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            margin-bottom: 0;
            min-width: 0;
            transition: background 0.2s;
          }
          .detail-row:hover {
            background: #f1f5f9;
          }
          .detail-label {
            color: #334155;
            font-size: 1.05rem;
            min-width: 110px;
            font-weight: 600;
            margin-left: 10px;
          }
          .detail-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 1.08rem;
            word-break: break-word;
          }
          .detail-row.total,
          .detail-row.grand-total {
            grid-column: 1 / -1;
            background: #f0f7ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            padding: 1.1rem 1.2rem;
            margin-top: 0.5rem;
            font-size: 1.15rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.05);
          }
          .detail-row.grand-total {
            background: #1e40af;
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
          }
          .detail-row.grand-total .detail-label,
          .detail-row.grand-total .detail-value {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
          }
          .detail-row.total .detail-label,
          .detail-row.total .detail-value {
            color: #1e40af;
            font-weight: 600;
          }
          .detail-row.total:hover {
            background: #e0f2fe;
          }
          .detail-row.grand-total:hover {
            background: #1e3a8a;
          }
          .section-header h4 {
            font-size: 1.15rem;
            color: #1e293b;
            font-weight: 700;
            margin: 0;
          }
          .section-actions {
            display: flex;
            gap: 8px;
          }
          .btn-icon {
            padding: 0.6rem;
            border: none;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: #64748b;
          }
          .btn-icon:hover {
            background: #e2e8f0;
            color: #2563eb;
          }
          .btn-icon[title*="حفظ"] {
            color: #22c55e;
          }
          .btn-icon[title*="حفظ"]:hover {
            background: #dcfce7;
            color: #16a34a;
          }
          .btn-icon[title*="إلغاء"] {
            color: #ef4444;
          }
          .btn-icon[title*="إلغاء"]:hover {
            background: #fee2e2;
            color: #dc2626;
          }
          .edit-inline-btn {
            margin-right: 5px;
            padding: 0.4rem;
            border: none;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
          }

          .edit-inline-btn.save-btn {
            color: #22c55e;
          }

          .edit-inline-btn.save-btn:hover {
            background: #dcfce7;
          }

          .edit-inline-btn.cancel-btn {
            color: #ef4444;
          }

          .edit-inline-btn.cancel-btn:hover {
            background: #fee2e2;
          }

          .detail-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
          }

          .edit-input {
            width: 120px;
            padding: 0.4rem 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
          }
        </style>

        <script>
          function toggleEditMode(sectionType) {
            const section = document.querySelector(
              `.bill-section:has(button[onclick="toggleEditMode('${sectionType}')"])`
            );
            const sectionHeader = section.querySelector(".section-header");
            const editButton = section.querySelector(".btn-icon");
            const isEditing = editButton.classList.contains("editing");

            if (isEditing) {
              section.classList.remove("editing");
              // إزالة أزرار الحفظ والإلغاء
              const saveBtn = sectionHeader.querySelector(".save-btn");
              const cancelBtn = sectionHeader.querySelector(".cancel-btn");
              if (saveBtn) saveBtn.remove();
              if (cancelBtn) cancelBtn.remove();
              // إعادة زر التعديل
              editButton.style.display = "block";
            } else {
              section.classList.add("editing");
              // إخفاء زر التعديل
              editButton.style.display = "none";

              // إضافة أزرار الحفظ والإلغاء
              const saveBtn = document.createElement("button");
              saveBtn.type = "button";
              saveBtn.className = "btn-icon save-btn";
              saveBtn.title = "حفظ";
              saveBtn.innerHTML = '<i class="fas fa-save"></i>';
              saveBtn.onclick = function () {
                saveChanges(section);
                toggleEditMode(sectionType);
              };

              const cancelBtn = document.createElement("button");
              cancelBtn.type = "button";
              cancelBtn.className = "btn-icon cancel-btn";
              cancelBtn.title = "إلغاء";
              cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
              cancelBtn.onclick = function () {
                // إعادة القيم إلى حالتها الأصلية
                const inputs = section.querySelectorAll(".edit-input");
                const values = section.querySelectorAll(".detail-value");
                inputs.forEach((input, index) => {
                  input.style.display = "none";
                  values[index].style.display = "block";
                });
                // إعادة الحالة إلى وضع القراءة
                section.classList.remove("editing");
                // إزالة أزرار الحفظ والإلغاء
                saveBtn.remove();
                cancelBtn.remove();
                // إعادة زر التعديل
                editButton.style.display = "block";
              };

              sectionHeader.appendChild(saveBtn);
              sectionHeader.appendChild(cancelBtn);
            }

            // تبديل عرض القيم وحقول الإدخال
            const inputs = section.querySelectorAll(".edit-input");
            const values = section.querySelectorAll(".detail-value");

            inputs.forEach((input, index) => {
              if (isEditing) {
                input.style.display = "none";
                values[index].style.display = "block";
              } else {
                input.style.display = "block";
                values[index].style.display = "none";
                input.value = values[index].textContent.replace(" ريال", "");
              }
            });
          }

          function saveChanges(section) {
            const inputs = section.querySelectorAll(".edit-input");
            const values = section.querySelectorAll(".detail-value");

            inputs.forEach((input, index) => {
              const newValue = input.value;
              if (input.type === "number") {
                values[index].textContent = `${newValue} ريال`;
              } else {
                values[index].textContent = newValue;
              }
            });

            // تحديث الإجماليات
            updateTotals();
          }

          function updateTotals() {
            // تحديث إجمالي الكهرباء
            const electricityCurrent = parseInt(
              document.querySelector(".bill-section:nth-child(2) .detail-value")
                .textContent
            );
            const electricityOverdue = parseInt(
              document.querySelector(
                ".bill-section:nth-child(2) .detail-row:nth-child(2) .detail-value"
              ).textContent
            );
            const electricityTotal = electricityCurrent + electricityOverdue;
            document.querySelector(
              ".bill-section:nth-child(2) .detail-row.total .detail-value"
            ).textContent = `${electricityTotal} ريال`;

            // تحديث إجمالي الماء
            const waterCurrent = parseInt(
              document.querySelector(".bill-section:nth-child(3) .detail-value")
                .textContent
            );
            const waterOverdue = parseInt(
              document.querySelector(
                ".bill-section:nth-child(3) .detail-row:nth-child(2) .detail-value"
              ).textContent
            );
            const waterTotal = waterCurrent + waterOverdue;
            document.querySelector(
              ".bill-section:nth-child(3) .detail-row.total .detail-value"
            ).textContent = `${waterTotal} ريال`;

            // تحديث إجمالي الإيجار
            const rentCurrent = parseInt(
              document.querySelector(".bill-section:nth-child(4) .detail-value")
                .textContent
            );
            const rentOverdue = parseInt(
              document.querySelector(
                ".bill-section:nth-child(4) .detail-row:nth-child(2) .detail-value"
              ).textContent
            );
            const rentTotal = rentCurrent + rentOverdue;
            document.querySelector(
              ".bill-section:nth-child(4) .detail-row.total .detail-value"
            ).textContent = `${rentTotal} ريال`;

            // تحديث إجمالي الفاتورة
            const grandTotal = electricityTotal + waterTotal + rentTotal;
            document.querySelector(
              ".total-section .grand-total .detail-value"
            ).textContent = `${grandTotal} ريال`;
          }
        </script>
      </div>

      <!-- نافذة تعديل الفاتورة -->
      <div id="editInvoiceModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>تعديل بيانات الفاتورة</h3>
            <button class="btn-close" onclick="closeModal('editInvoiceModal')">
              ×
            </button>
          </div>
          <form class="form" id="editInvoiceForm">
            <div class="form-sections">
              <div class="form-section">
                <h4>بيانات الفاتورة</h4>
                <div
                  class="form-grid"
                  style="grid-template-columns: repeat(2, 1fr); gap: 20px"
                >
                  <div class="form-group">
                    <label for="edit-store-name">اسم المحل</label>
                    <input type="text" id="edit-store-name" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-owner-name">اسم صاحب المحل</label>
                    <input type="text" id="edit-owner-name" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-electricity">الكهرباء (ريال)</label>
                    <input type="number" id="edit-electricity" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-water">الماء (ريال)</label>
                    <input type="number" id="edit-water" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-rent">الإيجار (ريال)</label>
                    <input type="number" id="edit-rent" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-month">الشهر</label>
                    <input type="month" id="edit-month" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-overdue">المتأخرات (ريال)</label>
                    <input type="number" id="edit-overdue" required />
                  </div>
                  <div class="form-group">
                    <label for="edit-total">الإجمالي (ريال)</label>
                    <input type="number" id="edit-total" required />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-green">حفظ التغييرات</button>
              <button
                type="button"
                class="btn-secondary"
                onclick="closeModal('editInvoiceModal')"
              >
                إلغاء
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script src="../views/js/mall-management/index.js"></script>
    <script>
      // دالة لفتح نافذة تعديل القسم
      function editSection(sectionType) {
        // إخفاء نافذة التفاصيل
        document.getElementById("invoiceDetailsModal").style.display = "none";

        // فتح نافذة التعديل
        const editModal = document.getElementById("editInvoiceModal");
        editModal.style.display = "block";

        // تعبئة البيانات الحالية في نموذج التعديل
        const currentData = getCurrentSectionData(sectionType);
        fillEditForm(currentData, sectionType);
      }

      // دالة للحصول على بيانات القسم الحالي
      function getCurrentSectionData(sectionType) {
        const modal = document.getElementById("invoiceDetailsModal");
        let data = {};

        switch (sectionType) {
          case "store-info":
            data = {
              storeName: modal.querySelector(
                ".bill-section:nth-child(1) .detail-row:nth-child(1) .detail-value"
              ).textContent,
              ownerName: modal.querySelector(
                ".bill-section:nth-child(1) .detail-row:nth-child(2) .detail-value"
              ).textContent,
            };
            break;
          case "electricity":
            data = {
              current: modal
                .querySelector(
                  ".bill-section:nth-child(2) .detail-row:nth-child(1) .detail-value"
                )
                .textContent.replace(" ريال", ""),
              overdue: modal
                .querySelector(
                  ".bill-section:nth-child(2) .detail-row:nth-child(2) .detail-value"
                )
                .textContent.replace(" ريال", ""),
            };
            break;
          case "water":
            data = {
              current: modal
                .querySelector(
                  ".bill-section:nth-child(3) .detail-row:nth-child(1) .detail-value"
                )
                .textContent.replace(" ريال", ""),
              overdue: modal
                .querySelector(
                  ".bill-section:nth-child(3) .detail-row:nth-child(2) .detail-value"
                )
                .textContent.replace(" ريال", ""),
            };
            break;
          case "rent":
            data = {
              current: modal
                .querySelector(
                  ".bill-section:nth-child(4) .detail-row:nth-child(1) .detail-value"
                )
                .textContent.replace(" ريال", ""),
              overdue: modal
                .querySelector(
                  ".bill-section:nth-child(4) .detail-row:nth-child(2) .detail-value"
                )
                .textContent.replace(" ريال", ""),
            };
            break;
        }

        return data;
      }

      // دالة لملء نموذج التعديل بالبيانات الحالية
      function fillEditForm(data, sectionType) {
        const form = document.getElementById("editInvoiceForm");

        // تحديث عنوان النموذج
        const modalTitle = editModal.querySelector(".modal-header h3");
        modalTitle.textContent = `تعديل ${getSectionTitle(sectionType)}`;

        // إخفاء جميع حقول النموذج
        const allFields = form.querySelectorAll(".form-group");
        allFields.forEach((field) => (field.style.display = "none"));

        // إظهار الحقول المطلوبة فقط
        switch (sectionType) {
          case "store-info":
            document.getElementById("edit-store-name").value = data.storeName;
            document.getElementById("edit-owner-name").value = data.ownerName;
            document.getElementById(
              "edit-store-name"
            ).parentElement.style.display = "block";
            document.getElementById(
              "edit-owner-name"
            ).parentElement.style.display = "block";
            break;
          case "electricity":
          case "water":
          case "rent":
            const currentField = document.getElementById(`edit-${sectionType}`);
            const overdueField = document.getElementById("edit-overdue");
            currentField.value = data.current;
            overdueField.value = data.overdue;
            currentField.parentElement.style.display = "block";
            overdueField.parentElement.style.display = "block";
            break;
        }
      }

      // دالة للحصول على عنوان القسم
      function getSectionTitle(sectionType) {
        const titles = {
          "store-info": "معلومات المحل",
          electricity: "فاتورة الكهرباء",
          water: "فاتورة الماء",
          rent: "فاتورة الإيجار",
        };
        return titles[sectionType] || "";
      }

      // دالة لحفظ التعديلات
      function saveEditChanges(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // هنا يمكنك إضافة كود لإرسال البيانات إلى الخادم
        console.log("تم حفظ التعديلات:", Object.fromEntries(formData));

        // إغلاق نافذة التعديل
        closeModal("editInvoiceModal");

        // إعادة فتح نافذة التفاصيل مع البيانات المحدثة
        document.getElementById("invoiceDetailsModal").style.display = "block";

        // تحديث البيانات في نافذة التفاصيل
        updateInvoiceDetails(formData);
      }

      // دالة لتحديث البيانات في نافذة التفاصيل
      function updateInvoiceDetails(formData) {
        // هنا يمكنك إضافة كود لتحديث البيانات في نافذة التفاصيل
        // بناءً على البيانات المستلمة من النموذج
      }

      // إضافة مستمع الحدث لنموذج التعديل
      document
        .getElementById("editInvoiceForm")
        .addEventListener("submit", saveEditChanges);
    </script>

    <!-- نافذة الرسالة المنبثقة -->
    <div id="messageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>إرسال رسالة</h3>
          <button class="btn-close" onclick="closeModal('messageModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="messageForm" class="form">
          <div class="form-group">
            <label>محتوى الرسالة</label>
            <textarea
              id="messageContent"
              rows="5"
              placeholder="اكتب رسالتك هنا..."
              required
            ></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-green">
              <i class="fas fa-paper-plane"></i>
              إرسال
            </button>
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModal('messageModal')"
            >
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>

    <style>
      /* تنسيقات نافذة الرسالة */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        width: 90%;
        max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
      }

      .modal-header h3 {
        font-size: 1.5rem;
        color: #1e293b;
        margin: 0;
      }

      .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #64748b;
        cursor: pointer;
        padding: 0.5rem;
        transition: all 0.2s;
      }

      .btn-close:hover {
        color: #ef4444;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #475569;
        font-weight: 500;
      }

      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        resize: vertical;
        min-height: 120px;
      }

      .form-group textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
      }
    </style>

    <script>
      // دالة فتح نافذة الرسالة
      function sendMessage(invoiceId) {
        const modal = document.getElementById("messageModal");
        const form = document.getElementById("messageForm");

        // إظهار النافذة المنبثقة
        modal.style.display = "block";

        // إعادة تعيين النموذج
        form.reset();
      }

      // دالة إغلاق النافذة المنبثقة
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // معالجة إرسال الرسالة
      document
        .getElementById("messageForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const content = document.getElementById("messageContent").value;

          // هنا يمكنك إضافة كود لإرسال الرسالة إلى الخادم
          console.log("إرسال رسالة:", {
            content,
          });

          // إغلاق النافذة المنبثقة
          closeModal("messageModal");

          // إظهار رسالة نجاح
          alert("تم إرسال الرسالة بنجاح");
        });

      // إغلاق النافذة المنبثقة عند النقر خارجها
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
    </script>

    <style>
      /* تنسيقات قسم الفلترة */
      .filter-controls {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .filter-group {
        flex: 1;
        display: flex;
        gap: 1rem;
      }

      .search-box {
        flex: 1;
      }

      .search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-dark {
        white-space: nowrap;
        padding: 0.75rem 1.5rem;
      }

      /* تنسيقات الجدول */
      .table-wrapper {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-top: 1rem;
      }

      .table-wrapper table {
        width: 100%;
        border-collapse: collapse;
      }

      .table-wrapper thead {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }

      .table-wrapper thead th {
        padding: 1rem;
        text-align: right;
        font-weight: 600;
        color: #1e293b;
        border-bottom: 2px solid #e2e8f0;
        background: #f8fafc;
      }

      .table-wrapper tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s;
      }

      .table-wrapper tbody tr:hover {
        background-color: #f1f5f9;
      }

      .table-wrapper tbody td {
        padding: 1rem;
        color: #334155;
      }

      /* تنسيق شريط التمرير */
      .table-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .table-wrapper::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }

      .table-wrapper::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* تحسين تصميم صف الفلاتر في الجدول */
      .table-wrapper table .filter-row {
        background: #f1f5f9;
      }
      .table-wrapper table .filter-row td {
        padding: 0.5rem 0.7rem;
        border-bottom: 1px solid #e2e8f0;
      }
      .table-wrapper table .filter-row select.table-filter-input {
        width: 100%;
        min-width: 90px;
        max-width: 140px;
        height: 38px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: #fff;
        color: #1e293b;
        font-size: 1rem;
        text-align: center;
        transition: border-color 0.2s, box-shadow 0.2s;
        margin: 0 auto;
        display: block;
        box-shadow: none;
      }
      .table-wrapper table .filter-row select.table-filter-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37,99,235,0.08);
        outline: none;
      }
      .table-wrapper table .filter-row select.table-filter-input:hover {
        border-color: #94a3b8;
        background: #f8fafc;
      }
      .table-wrapper table .filter-row select.table-filter-input option {
        text-align: right;
      }
    </style>

    <script>
      // دالة تطبيق الفلاتر على الجدول
      function applyFilters() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
          const storeName = row.cells[0].textContent.toLowerCase();
          const ownerName = row.cells[1].textContent.toLowerCase();
          
          // فلترة حسب البحث النصي
          const matchesSearch = storeName.includes(searchInput) || ownerName.includes(searchInput);
          
          // إظهار أو إخفاء الصف بناءً على البحث
          row.style.display = matchesSearch ? '' : 'none';
        });
      }

      function fillMonthFilter() {
        const monthSet = new Set();
        document.querySelectorAll('tbody tr').forEach(row => {
          if (row.classList.contains('filter-row')) return;
          const month = row.cells[5]?.textContent.trim();
          if (month) monthSet.add(month);
        });
        const select = document.getElementById('filter-month');
        if (!select) return;
        select.innerHTML = '<option value="all">الكل</option>';
        Array.from(monthSet).forEach(month => {
          const option = document.createElement('option');
          option.value = month;
          option.textContent = month;
          select.appendChild(option);
        });
      }

      function applyTableFilters() {
        const monthValue = document.getElementById('filter-month').value;
        const overdueValue = document.getElementById('filter-overdue').value;
        const totalValue = document.getElementById('filter-total').value;

        document.querySelectorAll('tbody tr').forEach(row => {
          if (row.classList.contains('filter-row')) return;
          const month = row.cells[5]?.textContent.trim();
          const overdue = parseInt(row.cells[6]?.textContent.replace(/[^\d]/g, '')) || 0;
          const total = parseInt(row.cells[7]?.textContent.replace(/[^\d]/g, '')) || 0;
          let show = true;
          if (monthValue !== 'all' && month !== monthValue) show = false;
          if (overdueValue === 'yes' && overdue === 0) show = false;
          if (overdueValue === 'no' && overdue > 0) show = false;
          if (totalValue === 'paid' && total > 0) show = false;
          if (totalValue === 'unpaid' && total === 0) show = false;
          row.style.display = show ? '' : 'none';
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        fillMonthFilter();
        document.getElementById('filter-month').addEventListener('change', applyTableFilters);
        document.getElementById('filter-overdue').addEventListener('change', applyTableFilters);
        document.getElementById('filter-total').addEventListener('change', applyTableFilters);
      });
    </script>

    <script>
      // Add these functions to handle the bulk message modal
      function openBulkMessageModal() {
        document.getElementById('bulkMessageModal').style.display = 'block';
      }

      function closeBulkMessageModal() {
        document.getElementById('bulkMessageModal').style.display = 'none';
        document.getElementById('bulkMessageForm').reset();
      }

      function handleBulkMessage(event) {
        event.preventDefault();
        const message = document.getElementById('bulkMessageText').value.trim();
        
        if (message) {
          window.mallManagerChat.sendMessageToAll(message);
          closeBulkMessageModal();
        }
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('bulkMessageModal');
        if (event.target === modal) {
          closeBulkMessageModal();
        }
      }
    </script>

    <script src="../views/js/fonts.js"></script>
    <script> 
      // دالة طباعة الفاتورة
      function printBill(billId) {
        const billData = getBillData(billId);
        if (billData) {
          const invoiceContent = `
            <div class="invoice-print">
              <div class="invoice-header">
                <div class="mall-info">
                  <h1>اسم المول</h1>
                  <p>العنوان: شارع الرئيسي، المدينة</p>
                  <p>هاتف: 0123456789</p>
                  <p>البريد الإلكتروني: mall@example.com</p>
                </div>
                <div class="invoice-info">
                  <h2>فاتورة إيجار</h2>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="label">رقم الفاتورة:</span>
                      <span class="value">${billData.id}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">التاريخ:</span>
                      <span class="value">${billData.date}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">اسم المستأجر:</span>
                      <span class="value">${billData.tenantName}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">رقم المحل:</span>
                      <span class="value">${billData.storeNumber}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">الحالة:</span>
                      <span class="value">${billData.status}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="invoice-body">
                <table class="bill-details-table">
                  <thead>
                    <tr>
                      <th>البند</th>
                      <th>التفاصيل</th>
                      <th>المبلغ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>إيجار المحل</td>
                      <td>إيجار شهر ${billData.month}</td>
                      <td>${billData.rent} ريال</td>
                    </tr>
                    <tr>
                      <td>استهلاك الكهرباء</td>
                      <td>${billData.electricityUsage} كيلوواط</td>
                      <td>${billData.electricityBill} ريال</td>
                    </tr>
                    <tr>
                      <td>استهلاك الماء</td>
                      <td>${billData.waterUsage} متر مكعب</td>
                      <td>${billData.waterBill} ريال</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="invoice-summary">
                <div class="summary-grid">
                  <div class="summary-item">
                    <span class="label">إجمالي الإيجار:</span>
                    <span class="value">${billData.rent} ريال</span>
                  </div>
                  <div class="summary-item">
                    <span class="label">إجمالي الكهرباء:</span>
                    <span class="value">${billData.electricityBill} ريال</span>
                  </div>
                  <div class="summary-item">
                    <span class="label">إجمالي الماء:</span>
                    <span class="value">${billData.waterBill} ريال</span>
                  </div>
                  <div class="summary-item total">
                    <span class="label">الإجمالي النهائي:</span>
                    <span class="value">${billData.total} ريال</span>
                  </div>
                </div>
              </div>

              <div class="invoice-footer">
                <p>شكراً لتعاملكم معنا</p>
                <p>للاستفسارات يرجى التواصل مع إدارة المول</p>
              </div>
            </div>
          `;

          const printWindow = window.open("", "_blank");
          printWindow.document.write(`
            <html dir="rtl">
              <head>
                <title>فاتورة إيجار - ${billData.id}</title>
                <style>
                  @media print {
                    body {
                      font-family: Arial, sans-serif;
                      margin: 0;
                      padding: 20px;
                      color: #333;
                    }

                    .invoice-print {
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                    }

                    .invoice-header {
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 30px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #eee;
                    }

                    .mall-info {
                      text-align: right;
                    }

                    .mall-info h1 {
                      margin: 0 0 10px 0;
                      color: #1e40af;
                      font-size: 24px;
                    }

                    .mall-info p {
                      margin: 5px 0;
                      color: #666;
                      font-size: 14px;
                    }

                    .invoice-info {
                      text-align: left;
                    }

                    .invoice-info h2 {
                      margin: 0 0 15px 0;
                      color: #1e40af;
                      font-size: 20px;
                    }

                    .info-grid {
                      display: grid;
                      grid-template-columns: repeat(2, 1fr);
                      gap: 10px;
                    }

                    .info-item {
                      display: flex;
                      flex-direction: column;
                      gap: 2px;
                    }

                    .info-item .label {
                      font-size: 12px;
                      color: #666;
                    }

                    .info-item .value {
                      font-size: 14px;
                      font-weight: bold;
                      color: #333;
                    }

                    .bill-details-table {
                      width: 100%;
                      border-collapse: collapse;
                      margin: 20px 0;
                    }

                    .bill-details-table th,
                    .bill-details-table td {
                      padding: 10px;
                      text-align: right;
                      border: 1px solid #ddd;
                      font-size: 14px;
                    }

                    .bill-details-table th {
                      background-color: #f8fafc;
                      font-weight: bold;
                      color: #1e40af;
                    }

                    .bill-details-table tr:nth-child(even) {
                      background-color: #f8fafc;
                    }

                    .invoice-summary {
                      margin-top: 20px;
                      padding: 15px;
                      background-color: #f8fafc;
                      border-radius: 8px;
                    }

                    .summary-grid {
                      display: grid;
                      grid-template-columns: repeat(2, 1fr);
                      gap: 10px;
                    }

                    .summary-item {
                      display: flex;
                      justify-content: space-between;
                      padding: 8px;
                      border-bottom: 1px solid #eee;
                    }

                    .summary-item.total {
                      grid-column: 1 / -1;
                      background-color: #1e40af;
                      color: white;
                      border-radius: 4px;
                      margin-top: 10px;
                      padding: 12px;
                    }

                    .summary-item.total .label,
                    .summary-item.total .value {
                      color: white;
                      font-weight: bold;
                    }

                    .invoice-footer {
                      margin-top: 30px;
                      text-align: center;
                      padding-top: 20px;
                      border-top: 2px solid #eee;
                    }

                    .invoice-footer p {
                      margin: 5px 0;
                      color: #666;
                      font-size: 14px;
                    }

                    @page {
                      size: A4;
                      margin: 0;
                    }
                  }
                </style>
              </head>
              <body>
                ${invoiceContent}
              </body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
        }
      }

      // دالة للحصول على بيانات الفاتورة
      function getBillData(billId) {
        // هنا يمكنك استبدال هذا بالكود الفعلي للحصول على بيانات الفاتورة من قاعدة البيانات
        return {
          id: billId,
          date: new Date().toLocaleDateString('ar-SA'),
          tenantName: "أحمد محمد",
          storeNumber: "A101",
          status: "مدفوعة",
          month: "يناير 2024",
          rent: 5000,
          electricityUsage: 500,
          electricityBill: 250,
          waterUsage: 100,
          waterBill: 150,
          total: 5400
        };
      }
    </script>

    <!-- إضافة مكتبة html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      // ... existing code ...

      // دالة تحميل PDF
      function downloadPDF(billId) {
        const billData = getBillData(billId);
        if (billData) {
          const invoiceContent = `
            <div class="invoice-print">
              <div class="invoice-header">
                <div class="store-info">
                  <h1>اسم المول</h1>
                  <p>العنوان: شارع الرئيسي، المدينة</p>
                  <p>هاتف: 0123456789</p>
                  <p>البريد الإلكتروني: mall@example.com</p>
                </div>
                <div class="invoice-info">
                  <h2>فاتورة الخدمات </h2>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="label">رقم الفاتورة:</span>
                      <span class="value">${billData.id}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">التاريخ:</span>
                      <span class="value">${billData.date}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">اسم المستأجر:</span>
                      <span class="value">${billData.tenantName}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">رقم المحل:</span>
                      <span class="value">${billData.storeNumber}</span>
                    </div>
                    <div class="info-item">
                      <span class="label">الحالة:</span>
                      <span class="value">${billData.status}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="invoice-body">
                <table class="products-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>البند</th>
                      <th>التفاصيل</th>
                      <th>المبلغ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>1</td>
                      <td>إيجار المحل</td>
                      <td>إيجار شهر ${billData.month}</td>
                      <td>${billData.rent} ريال</td>
                    </tr>
                    <tr>
                      <td>2</td>
                      <td>استهلاك الكهرباء</td>
                      <td>فاتورة شهر ${billData.month}</td>
                      <td>${billData.electricityBill} ريال</td>
                    </tr>
                    <tr>
                      <td>3</td>
                      <td>استهلاك الماء</td>
                      <td>فاتورة شهر ${billData.month}</td>
                      <td>${billData.waterBill} ريال</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="invoice-summary">
                <div class="summary-grid">
                  <div class="summary-item total">
                    <span class="label">الإجمالي النهائي:</span>
                    <span class="value">${billData.total} ريال</span>
                  </div>
                </div>
              </div>

              <div class="invoice-footer">
                <p>شكراً لتعاملكم معنا</p>
                <p>للاستفسارات يرجى التواصل مع إدارة المول</p>
              </div>
            </div>
          `;

          // إنشاء عنصر مؤقت لتحويله إلى PDF
          const tempElement = document.createElement('div');
          tempElement.innerHTML = invoiceContent;
          document.body.appendChild(tempElement);

          // خيارات تحويل PDF
          const options = {
            margin: 10,
            filename: `فاتورة_${billData.id}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2,
              useCORS: true,
              logging: true,
              letterRendering: true
            },
            jsPDF: { 
              unit: 'mm', 
              format: 'a4', 
              orientation: 'portrait',
              direction: 'rtl'
            }
          };

          // تحويل المحتوى إلى PDF وتحميله
          html2pdf().from(tempElement).set(options).save().then(() => {
            document.body.removeChild(tempElement);
          });
        }
      }

      // دالة للحصول على بيانات الفاتورة
      function getBillData(billId) {
        // هنا يمكنك استبدال هذا بالكود الفعلي للحصول على بيانات الفاتورة من قاعدة البيانات
        return {
          id: billId,
          date: new Date().toLocaleDateString('ar-SA'),
          tenantName: "أحمد محمد",
          storeNumber: "A101",
          status: "مدفوعة",
          month: "يناير 2024",
          rent: 5000,
          electricityUsage: 500,
          electricityBill: 250,
          waterUsage: 100,
          waterBill: 150,
          total: 5400
        };
      }

      // تنسيقات الطباعة
      const printStyles = `
        @media print {
          body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
          }

          .invoice-print {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
          }

          .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
          }

          .store-info {
            text-align: right;
          }

          .store-info h1 {
            margin: 0 0 10px 0;
            color: #1e40af;
            font-size: 24px;
          }

          .store-info p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
          }

          .invoice-info {
            text-align: left;
          }

          .invoice-info h2 {
            margin: 0 0 15px 0;
            color: #1e40af;
            font-size: 20px;
          }

          .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
          }

          .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
          }

          .info-item .label {
            font-size: 12px;
            color: #666;
          }

          .info-item .value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
          }

          .products-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
          }

          .products-table th,
          .products-table td {
            padding: 10px;
            text-align: right;
            border: 1px solid #ddd;
            font-size: 14px;
          }

          .products-table th {
            background-color: #f8fafc;
            font-weight: bold;
            color: #1e40af;
          }

          .products-table tr:nth-child(even) {
            background-color: #f8fafc;
          }

          .invoice-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 8px;
          }

          .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
          }

          .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
          }

          .summary-item.total {
            grid-column: 1 / -1;
            background-color: #1e40af;
            color: white;
            border-radius: 4px;
            margin-top: 10px;
            padding: 12px;
          }

          .summary-item.total .label,
          .summary-item.total .value {
            color: white;
            font-weight: bold;
          }

          .invoice-footer {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #eee;
          }

          .invoice-footer p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
          }

          @page {
            size: A4;
            margin: 0;
          }
        }
      `;
    </script>

  </body>
</html>
