<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IEMM - إدارة المحلات</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../views/css/styles.css" />
    <link rel="stylesheet" href="../views/css/malls-dashbboard/mall.css" />
    <link rel="stylesheet" href="../views/css/chat.css" />
    <script src="../views/js/script.js" defer></script>
    <script src="../views/js/chat.js" defer></script>
    <script src="../views/js/theme-manager.js" defer></script>
    <!-- <script src="../views/js/mall-management/sotores-management.js" defer></script> -->
    <!-- إضافة مكتبة Font Awesome للأيقونات -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* حذف الأنماط المكررة وتنظيمها */
      .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
      }

      .view-toggle-buttons,
      .action-buttons {
        display: flex;
        gap: 1rem;
      }

      .btn-dark,
      .btn-green {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        min-width: 160px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn-dark {
        background: #2563eb;
        color: white;
      }

      .btn-dark:hover {
        background: #1e3a8a;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-green {
        background: #22c55e;
        color: white;
      }

      .btn-green:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .list-toggle-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .list-toggle-bar .btn-dark {
        background: #f1f5f9;
        color: #1e293b;
        border: 1px solid #e2e8f0;
      }

      .list-toggle-bar .btn-dark:hover {
        background: #e2e8f0;
        color: #1e293b;
      }

      .list-toggle-bar .btn-dark.active {
        background: #2563eb;
        color: white;
        border: none;
      }

      .list-section {
        transition: all 0.3s ease;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        margin-top: 1.5rem;
      }

      .search-box {
        position: relative;
        width: 300px;
      }

      .search-input {
        width: 100%;
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: white;
      }

      .search-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        font-size: 1rem;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
        border-radius: 12px 12px 0 0;
      }

      .table-header h3 {
        font-size: 1.25rem;
        color: #1e293b;
        font-weight: 600;
        margin: 0;
      }

      .table-wrapper {
        padding: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
        position: relative;
      }

      .table-wrapper table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      .table-wrapper th {
        padding: 1rem;
        text-align: right;
        font-weight: 600;
        color: #1e293b;
        background-color: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .table-wrapper td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        color: #475569;
        font-size: 0.95rem;
      }

      .table-wrapper tr:last-child td {
        border-bottom: none;
      }

      .table-wrapper tr:hover {
        background-color: #f8fafc;
      }

      .btn-icon {
        padding: 0.5rem;
        border: none;
        background: none;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 6px;
        font-size: 1.1rem;
        color: #64748b;
      }

      .btn-icon:hover {
        background-color: #f1f5f9;
        color: #2563eb;
        transform: translateY(-1px);
      }

      .table-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .btn-green.btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        background-color: #22c55e;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-green.btn-sm:hover {
        background-color: #16a34a;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* تنسيق شريط التمرير */
      .table-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .table-wrapper::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }

      .table-wrapper::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* إضافة ظل عند التمرير */
      .table-wrapper::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 1)
        );
        pointer-events: none;
      }

      .table-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 1)
        );
        pointer-events: none;
      }

      /* تنسيق النماذج */
      .form-container {
        margin: 1.5rem 0;
        transition: all 0.3s ease;
        display: none;
      }

      .form.card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .form h3 {
        font-size: 1.5rem;
        color: #1e293b;
        margin-bottom: 1.5rem;
        font-weight: 600;
      }

      .form-section {
        margin-bottom: 2rem;
      }

      .form-section h4 {
        font-size: 1.2rem;
        color: #1e293b;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .form-group label {
        font-size: 0.95rem;
        color: #475569;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: flex-end;
      }

      .btn-secondary {
        background: #f1f5f9;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .btn-secondary:hover {
        background-color: #cbd5e1;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .floor-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .floor-controls button {
        background: #22c55e;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .floor-controls button:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .floor-controls span {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
      }

      /* تنسيق النافذة المنبثقة */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        width: 80%;
        max-width: 800px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal h3 {
        margin-bottom: 1.5rem;
        color: #1e293b;
        font-size: 1.5rem;
      }

      .modal .form-actions {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .btn-icon {
        padding: 0.5rem;
        border: none;
        background: none;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 6px;
        font-size: 1.1rem;
        color: #64748b;
      }

      .btn-icon:hover {
        background-color: #f1f5f9;
        color: #2563eb;
        transform: translateY(-1px);
      }

      /* تحسين عرض الحقول في نافذة العرض/التعديل */
      #viewEditModal .form-grid {
        display: flex !important;
        flex-direction: column;
        gap: 1.5rem;
        background: #f8fafc;
        border-radius: 10px;
        padding: 3rem 2rem 2rem 2rem; /* زيادة المسافة العلوية لتوفير مساحة لأيقونة التعديل */
        box-shadow: 0 1px 4px #e2e8f0;
        position: relative;
      }

      #viewEditModal .edit-all-btn {
        position: absolute;
        top: 0.5rem;
        left: 1.5rem;
        font-size: 1.2rem;
        color: #64748b;
        background: white;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.8rem;
        border-radius: 8px;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #viewEditModal .edit-all-btn:hover {
        color: #2563eb;
        background: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-color: #2563eb;
      }

      #viewEditModal .fields-row {
        display: flex;
        gap: 1.5rem;
        margin-top: 1rem;
      }

      #viewEditModal .field-row {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem 1.2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
        min-width: 0;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
      }

      #viewEditModal .field-row label {
        min-width: 120px;
        font-weight: 600;
        color: #2563eb;
        margin-left: 0;
        margin-bottom: 0.4rem;
        font-size: 1.05rem;
        white-space: nowrap;
      }

      #viewEditModal .field-value {
        font-size: 1.08rem;
        color: #1e293b;
        padding: 0 8px 0 0;
        word-break: break-word;
      }

      /* تعديل المسافة العلوية للعنوان */
      #viewEditModal .modal-content h3 {
        margin-top: 0.5rem;
        margin-bottom: 2rem;
        padding-right: 3rem; /* إضافة مسافة من اليمين لتجنب تداخل العنوان مع الأيقونة */
      }

      /* تعديل حجم النافذة المنبثقة */
      #viewEditModal .modal-content {
        max-width: 700px; /* زيادة عرض النافذة المنبثقة قليلاً */
        padding: 2rem;
      }

      #viewEditModal .edit-container {
        width: 100%;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        margin-top: 0.2rem;
        padding: 0.5rem 0.7rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }

      #viewEditModal .edit-input {
        width: 100%;
        margin: 0;
        padding: 0.6rem 0.8rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
        transition: all 0.2s;
      }

      #viewEditModal .edit-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
      }

      #viewEditModal .edit-buttons {
        display: none;
      }

      #viewEditModal .btn-save,
      #viewEditModal .btn-cancel {
        padding: 0.4rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        background: none;
      }

      #viewEditModal .btn-save {
        color: #22c55e;
      }

      #viewEditModal .btn-save:hover {
        background: rgba(34, 197, 94, 0.1);
      }

      #viewEditModal .btn-cancel {
        color: #ef4444;
      }

      #viewEditModal .btn-cancel:hover {
        background: rgba(239, 68, 68, 0.1);
      }

      #viewEditModal .edit-all-btn.editing {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
      }

      #viewEditModal .edit-all-btn.editing:hover {
        background: #16a34a;
        border-color: #16a34a;
      }

      /* تحسين تصميم وضع التعديل */
      #viewEditModal .edit-container {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        flex: 1;
        background: #f8fafc;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
      }

      #viewEditModal .edit-container:focus-within {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: white;
      }

      #viewEditModal .edit-input {
        flex: 1;
        padding: 0.6rem 0.8rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
        min-width: 0;
      }

      #viewEditModal .edit-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
      }

      #viewEditModal .edit-input[type="number"] {
        -moz-appearance: textfield;
      }

      #viewEditModal .edit-input[type="number"]::-webkit-outer-spin-button,
      #viewEditModal .edit-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      #viewEditModal .edit-buttons {
        display: flex;
        gap: 0.4rem;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      #viewEditModal .edit-container:hover .edit-buttons {
        opacity: 1;
      }

      #viewEditModal .btn-save,
      #viewEditModal .btn-cancel {
        padding: 0.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        background: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
      }

      #viewEditModal .btn-save {
        color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
      }

      #viewEditModal .btn-save:hover {
        background: #22c55e;
        color: white;
        transform: translateY(-1px);
      }

      #viewEditModal .btn-cancel {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      #viewEditModal .btn-cancel:hover {
        background: #ef4444;
        color: white;
        transform: translateY(-1px);
      }

      #viewEditModal .edit-all-btn {
        position: absolute;
        top: 0.5rem;
        left: 1.5rem;
        font-size: 1.2rem;
        color: #64748b;
        background: white;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.8rem;
        border-radius: 8px;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #viewEditModal .edit-all-btn:hover {
        color: #2563eb;
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-color: #2563eb;
      }

      #viewEditModal .edit-all-btn.editing {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }

      #viewEditModal .field-row {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 1rem 1.2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
        min-width: 0;
        transition: all 0.2s ease;
      }

      #viewEditModal .field-row:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      #viewEditModal .field-row label {
        min-width: 120px;
        font-weight: 600;
        color: #2563eb;
        margin-left: 12px;
        font-size: 1.05rem;
        white-space: nowrap;
      }

      #viewEditModal .field-value {
        flex: 1;
        font-size: 1.08rem;
        color: #1e293b;
        padding: 0 8px;
        word-break: break-word;
      }

      #viewEditModal select.edit-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: left 0.8rem center;
        padding-right: 2rem;
      }

      /* أضف تنسيق للزر النشط في الشريط العلوي */
      .header-bar .bar-btn.active-bar-btn {
        background: #e0f0ff;
        color: #2563eb;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.07);
        border: 1.5px solid #b6d5fa;
      }
      .header-bar .bar-btn.btn-green.active-bar-btn {
        background: #e6f9ed;
        color: #22c55e;
        border: 1.5px solid #b6e4c7;
      }
    </style>
    <script>
      function toggleForm(formId) {
        const form = document.getElementById(formId);
        const allForms = document.querySelectorAll(".form-container");
        const tablesContainer = document.getElementById("tables-view");

        if (form.style.display === "block") {
          form.style.display = "none";
          tablesContainer.style.display = "block";
          return;
        }

        allForms.forEach((f) => (f.style.display = "none"));
        form.style.display = "block";
        tablesContainer.style.display = "none";
      }

      function toggleList(listId) {
        // تحديث حالة الأزرار
        const buttons = document.querySelectorAll(".list-toggle-bar .btn-dark");
        buttons.forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        // إخفاء جميع القوائم
        const lists = document.querySelectorAll(".list-section");
        lists.forEach((list) => (list.style.display = "none"));

        // إظهار القائمة المطلوبة
        document.getElementById(listId).style.display = "block";
      }

      // تهيئة القوائم عند تحميل الصفحة
      document.addEventListener("DOMContentLoaded", function () {
        // إظهار قائمة المرافق افتراضياً
        document
          .querySelector(".list-toggle-bar .btn-dark")
          .classList.add("active");
        document.getElementById("facilities-list").style.display = "block";
      });

      function searchTable(listId, searchText) {
        const table = document.querySelector(`#${listId} table`);
        const rows = table.getElementsByTagName("tr");

        // تحويل نص البحث إلى حروف صغيرة
        searchText = searchText.toLowerCase();

        // بدء من الصف الثاني (تخطي رأس الجدول)
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const cells = row.getElementsByTagName("td");
          let found = false;

          // البحث في كل خلية في الصف
          for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell.textContent.toLowerCase().indexOf(searchText) > -1) {
              found = true;
              break;
            }
          }

          // إظهار أو إخفاء الصف بناءً على نتيجة البحث
          row.style.display = found ? "" : "none";
        }
      }

      // دالة فتح نافذة العرض/تعديل الحقل
      function openViewModal(data, type) {
        const modal = document.getElementById("viewEditModal");
        const title = document.getElementById("viewEditModalTitle");
        const fieldsContainer = document.getElementById("viewEditFields");
        fieldsContainer.innerHTML = "";

        // تعريف الحقول حسب النوع
        let fields = [];
        if (type === "facilities") {
          title.textContent = "بيانات المرفق";
          fields = [
            { label: "مبلغ الإيجار", key: "rent", type: "number" },
            { label: "رقم عداد الماء", key: "waterMeter", type: "text" },
            {
              label: "رقم عداد الكهرباء",
              key: "electricityMeter",
              type: "text",
            },
            { label: "الدور", key: "floor", type: "text" },
            { label: "الموقع X", key: "x", type: "number" },
            { label: "الموقع Y", key: "y", type: "number" },
            { label: "العرض", key: "width", type: "number" },
            { label: "الطول", key: "height", type: "number" },
          ];
        } else if (type === "tenants") {
          title.textContent = "بيانات صاحب المحل";
          fields = [
            { label: "الاسم", key: "name", type: "text" },
            { label: "رقم الجوال", key: "phone", type: "tel" },
            { label: "البريد الإلكتروني", key: "email", type: "email" },
            { label: "المحلات المستأجرة", key: "stores", type: "text" },
            {
              label: "النوع",
              key: "gender",
              type: "select",
              options: [
                { value: "male", label: "ذكر" },
                { value: "female", label: "أنثى" },
              ],
            },
            { label: "تاريخ الميلاد", key: "birthdate", type: "date" },
          ];
        } else if (type === "stores") {
          title.textContent = "بيانات المحل";
          fields = [
            { label: "اسم المالك", key: "owner", type: "text" },
            { label: "اسم المحل", key: "storeName", type: "text" },
            { label: "النشاط", key: "activity", type: "text" },
            { label: "تاريخ بدء العقد", key: "contractStart", type: "date" },
            { label: "أوقات الدوام", key: "workingHours", type: "text" },
          ];
        }

        // توليد الحقول
        fields.forEach((field) => {
          const value = data[field.key] || "";
          const fieldId = `view-field-${field.key}`;
          const fieldDiv = document.createElement("div");
          fieldDiv.className = "form-group";
          fieldDiv.style.position = "relative";
          // إذا كان النوع facilities أضف زر التعديل، غير ذلك لا تضف الزر
          if (type === "facilities") {
            fieldDiv.innerHTML = `
              <label>${field.label}</label>
              <span id="${fieldId}" class="field-value">${
              field.type === "date" && value ? value.split("T")[0] : value
            }</span>
              <button type="button" class="btn-icon edit-field-btn" title="تعديل" onclick="enableFieldEdit('${fieldId}', '${
              field.key
            }', '${
              field.type
            }', '${type}')" style="position:absolute; left:0; top:50%; transform:translateY(-50%);"><i class='fas fa-edit'></i></button>
            `;
          } else {
            fieldDiv.innerHTML = `
              <label>${field.label}</label>
              <span id="${fieldId}" class="field-value">${
              field.type === "date" && value ? value.split("T")[0] : value
            }</span>
            `;
          }
          fieldsContainer.appendChild(fieldDiv);
        });

        modal.style.display = "block";
      }

      // دالة إلغاء التعديل
      function cancelFieldEdit(fieldId, value) {
        const span = document.getElementById(fieldId);
        span.outerHTML = `<span id='${fieldId}' class='field-value'>${value}</span>`;
      }

      // تحديث أزرار الإجراءات في الجداول
      document.addEventListener("DOMContentLoaded", function () {
        // تحديث أزرار الإجراءات في جدول المرافق
        const facilitiesTable = document.querySelector(
          "#facilities-list table"
        );
        facilitiesTable.querySelectorAll("tr").forEach((row) => {
          const actionsCell = row.querySelector("td:last-child");
          if (actionsCell) {
            const storeData = {
              rent: "",
              waterMeter: "",
              electricityMeter: "",
              floor: row.cells[1].textContent,
              x: 0,
              y: 0,
              width: 0,
              height: 0,
            };

            actionsCell.innerHTML = `
              <button class="btn-icon" title="عرض" onclick='openViewModal(${JSON.stringify(
                storeData
              ).replace(/'/g, "\\'")}, "facilities")'>
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon" title="حذف" onclick="deleteStore(this)"><i class="fas fa-trash"></i></button>
            `;
          }
        });

        // تحديث أزرار الإجراءات في جدول أصحاب المحلات
        const tenantsTable = document.querySelector("#tenants-list table");
        tenantsTable.querySelectorAll("tr").forEach((row) => {
          const actionsCell = row.querySelector("td:last-child");
          if (actionsCell) {
            const tenantData = {
              name: row.cells[0].textContent,
              phone: row.cells[1].textContent,
              email: row.cells[2].textContent,
              stores: row.cells[3].textContent,
              gender: "",
              birthdate: "",
            };

            actionsCell.innerHTML = `
              <button class="btn-icon" title="عرض" onclick='openViewModal(${JSON.stringify(
                tenantData
              ).replace(/'/g, "\\'")}, "tenants")'>
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon" title="حذف" onclick="deleteStore(this)"><i class="fas fa-trash"></i></button>
            `;
          }
        });

        // تحديث أزرار الإجراءات في جدول المحلات
        const storesTable = document.querySelector("#stores-list table");
        storesTable.querySelectorAll("tr").forEach((row) => {
          const actionsCell = row.querySelector("td:last-child");
          if (actionsCell) {
            const storeData = {
              owner: row.cells[0].textContent,
              storeName: row.cells[1].textContent,
              activity: row.cells[2].textContent,
              contractStart: row.cells[5].textContent,
              workingHours: row.cells[6].textContent,
            };

            actionsCell.innerHTML = `
              <button class="btn-icon" title="عرض" onclick='openViewModal(${JSON.stringify(
                storeData
              ).replace(/'/g, "\\'")}, "stores")'>
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon" title="حذف" onclick="deleteStore(this)"><i class="fas fa-trash"></i></button>
            `;
          }
        });
      });

      // فتح نافذة عرض التفاصيل بيانات المرفق
      function openViewModal(data, type) {
        const modal = document.getElementById("viewEditModal");
        const title = document.getElementById("viewEditModalTitle");
        const fieldsContainer = document.getElementById("viewEditFields");
        fieldsContainer.innerHTML = "";

        let fields = [];
        if (type === "facilities") {
          title.textContent = "بيانات المرفق";
          fields = [
            {
              label: "مبلغ الإيجار",
              key: "rent",
              type: "number",
              group: "rent-floor",
            },
            { label: "الدور", key: "floor", type: "text", group: "rent-floor" },
            {
              label: "رقم عداد الماء",
              key: "waterMeter",
              type: "text",
              group: "meters",
            },
            {
              label: "رقم عداد الكهرباء",
              key: "electricityMeter",
              type: "text",
              group: "meters",
            },
            { label: "الموقع X", key: "x", type: "number", group: "location" },
            { label: "الموقع Y", key: "y", type: "number", group: "location" },
            {
              label: "العرض",
              key: "width",
              type: "number",
              group: "dimensions",
            },
            {
              label: "الطول",
              key: "height",
              type: "number",
              group: "dimensions",
            },
          ];
        } else if (type === "tenants") {
          title.textContent = "بيانات صاحب المحل";
          fields = [
            { label: "الاسم", key: "name", type: "text" },
            { label: "رقم الجوال", key: "phone", type: "tel" },
            { label: "البريد الإلكتروني", key: "email", type: "email" },
            { label: "المحلات المستأجرة", key: "stores", type: "text" },
            { label: "النوع", key: "gender", type: "select" },
            { label: "تاريخ الميلاد", key: "birthdate", type: "date" },
          ];
          // توليد صفوف ثنائية
          let fieldsHTML = "";
          for (let i = 0; i < fields.length; i += 2) {
            fieldsHTML += '<div class="fields-row">';
            for (let j = 0; j < 2; j++) {
              const field = fields[i + j];
              if (field) {
                const value = data[field.key] || "";
                const fieldId = `view-field-${field.key}`;
                fieldsHTML += `
                  <div class="field-row">
                    <label>${field.label}</label>
                    <span id="${fieldId}" class="field-value">${
                  field.type === "date" && value ? value.split("T")[0] : value
                }</span>
                  </div>
                `;
              }
            }
            fieldsHTML += "</div>";
          }
          fieldsContainer.innerHTML = fieldsHTML;
          // لا تضف زر التعديل هنا
          modal.style.display = "block";
          return;
        } else if (type === "stores") {
          title.textContent = "بيانات المحل";
          fields = [
            { label: "اسم المالك", key: "owner", type: "text" },
            { label: "اسم المحل", key: "storeName", type: "text" },
            { label: "النشاط", key: "activity", type: "text" },
            { label: "تاريخ بدء العقد", key: "contractStart", type: "date" },
            { label: "أوقات الدوام", key: "workingHours", type: "text" },
          ];
          // توليد صفوف ثنائية
          let fieldsHTML = "";
          for (let i = 0; i < fields.length; i += 2) {
            fieldsHTML += '<div class="fields-row">';
            for (let j = 0; j < 2; j++) {
              const field = fields[i + j];
              if (field) {
                const value = data[field.key] || "";
                const fieldId = `view-field-${field.key}`;
                fieldsHTML += `
                  <div class="field-row">
                    <label>${field.label}</label>
                    <span id="${fieldId}" class="field-value">${
                  field.type === "date" && value ? value.split("T")[0] : value
                }</span>
                  </div>
                `;
              }
            }
            fieldsHTML += "</div>";
          }
          fieldsContainer.innerHTML = fieldsHTML;
          // لا تضف زر التعديل هنا
          modal.style.display = "block";
          return;
        }

        // إضافة زر التعديل في الزاوية
        let fieldsHTML = "";
        if (type === "facilities") {
          fieldsHTML = `
            <button type="button" class="edit-all-btn" title="تعديل جميع الحقول" onclick="enableAllFieldsEdit('${type}')">
              <i class="fas fa-edit"></i>
            </button>
          `;

          // تجميع الحقول حسب المجموعات
          const groups = {
            "rent-floor": [],
            meters: [],
            location: [],
            dimensions: [],
          };

          fields.forEach((field) => {
            if (groups[field.group]) {
              groups[field.group].push(field);
            }
          });

          // إنشاء الصفوف المجمعة
          fieldsHTML += `
            <div class="fields-row">
              ${createFieldRow(groups["rent-floor"], data)}
            </div>
            <div class="fields-row">
              ${createFieldRow(groups["meters"], data)}
            </div>
            <div class="fields-row">
              ${createFieldRow(groups["location"], data)}
            </div>
            <div class="fields-row">
              ${createFieldRow(groups["dimensions"], data)}
            </div>
          `;
        } else {
          // توليد الحقول العادية للأنواع الأخرى
          fields.forEach((field) => {
            const value = data[field.key] || "";
            const fieldId = `view-field-${field.key}`;
            fieldsHTML += `
              <div class="field-row">
              <label>${field.label}</label>
              <span id="${fieldId}" class="field-value">${
              field.type === "date" && value ? value.split("T")[0] : value
            }</span>
              </div>
            `;
          });
        }

        fieldsContainer.innerHTML = fieldsHTML;
        modal.style.display = "block";
      }

      // دالة مساعدة لإنشاء صف من الحقول
      function createFieldRow(fields, data) {
        return fields
          .map((field) => {
            const value = data[field.key] || "";
            const fieldId = `view-field-${field.key}`;
            return `
            <div class="field-row">
              <label>${field.label}</label>
              <span id="${fieldId}" class="field-value">${
              field.type === "date" && value ? value.split("T")[0] : value
            }</span>
            </div>
            `;
          })
          .join("");
      }

      // دالة مساعدة للحصول على نوع الحقل
      function getFieldType(key, type) {
        const fieldTypes = {
          facilities: {
            rent: "number",
            waterMeter: "text",
            electricityMeter: "text",
            floor: "text",
            x: "number",
            y: "number",
            width: "number",
            height: "number",
          },
          tenants: {
            name: "text",
            phone: "tel",
            email: "email",
            stores: "text",
            gender: "select",
            birthdate: "date",
          },
          stores: {
            owner: "text",
            storeName: "text",
            activity: "text",
            contractStart: "date",
            workingHours: "text",
          },
        };
        return fieldTypes[type][key] || "text";
      }

      // دالة تفعيل تعديل بيانات المرفق
      function enableAllFieldsEdit(type, forceCancel = false) {
        const editBtn = document.querySelector(".edit-all-btn");
        const fields = document.querySelectorAll("#viewEditFields .field-row");
        const fieldsContainer = document.getElementById("viewEditFields");
        let actionBtns = document.getElementById("edit-actions-bottom");

        // إذا كان في وضع التعديل أو تم الضغط على زر الإلغاء
        if (editBtn.classList.contains("editing") || forceCancel) {
          editBtn.classList.remove("editing");
          editBtn.style.display = "";
          fields.forEach((field) => {
            const valueSpan = field.querySelector(".field-value");
            if (!valueSpan) {
              // إذا كان الحقل في وضع الإدخال، أعده إلى وضع العرض
              const input = field.querySelector(".edit-input");
              if (input) {
                const fieldId = input.id.replace("edit-", "");
                const originalValue =
                  input.getAttribute("data-original-value") || "";
                const span = document.createElement("span");
                span.id = fieldId;
                span.className = "field-value";
                span.textContent = originalValue;
                field
                  .querySelector(".edit-container")
                  .parentNode.replaceChild(
                    span,
                    field.querySelector(".edit-container")
                  );
              }
            } else {
              const originalValue = valueSpan.getAttribute(
                "data-original-value"
              );
              if (originalValue !== null) {
                cancelFieldEdit(valueSpan.id, originalValue);
              }
            }
          });
          if (actionBtns) actionBtns.remove();
        } else {
          // تفعيل وضع التعديل
          editBtn.classList.add("editing");
          editBtn.style.display = "none";
          fields.forEach((field) => {
            const valueSpan = field.querySelector(".field-value");
            if (valueSpan) {
              const fieldId = valueSpan.id;
              const fieldKey = fieldId.replace("view-field-", "");
              const fieldType = getFieldType(fieldKey, type);
              valueSpan.setAttribute(
                "data-original-value",
                valueSpan.textContent
              );
              enableFieldEdit(fieldId, fieldKey, fieldType, type);
            }
          });
          if (!document.getElementById("edit-actions-bottom")) {
            actionBtns = document.createElement("div");
            actionBtns.id = "edit-actions-bottom";
            actionBtns.style =
              "display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;";
            actionBtns.innerHTML = `
              <button type=\"button\" class=\"btn-save btn-green\" onclick=\"saveAllFieldsEdit('${type}')\"><i class='fas fa-check'></i></button>
              <button type=\"button\" class=\"btn-cancel btn-secondary\" onclick=\"enableAllFieldsEdit('${type}', true)\"><i class='fas fa-times'></i></button>
            `;
            fieldsContainer.appendChild(actionBtns);
          }
        }
      }

      // دالة تفعيل تعديل حقل معين
      function enableFieldEdit(fieldId, fieldKey, fieldType, type) {
        const span = document.getElementById(fieldId);
        if (!span) return;

        const currentValue = span.textContent.trim();

        let inputElement;
        if (fieldType === "select") {
          inputElement = document.createElement("select");
          if (fieldKey === "gender") {
            inputElement.innerHTML = `
                      <option value="male" ${
                        currentValue === "ذكر" ? "selected" : ""
                      }>ذكر</option>
                      <option value="female" ${
                        currentValue === "أنثى" ? "selected" : ""
                      }>أنثى</option>
                  `;
          }
        } else {
          inputElement = document.createElement("input");
          inputElement.type = fieldType;
          inputElement.value = currentValue;

          // إضافة خصائص إضافية حسب نوع الحقل
          if (fieldType === "number") {
            inputElement.min = "0";
            inputElement.step = "any";
          }
          if (fieldType === "tel") {
            inputElement.pattern = "[0-9]{10}";
            inputElement.placeholder = "05XXXXXXXX";
          }
          if (fieldType === "email") {
            inputElement.placeholder = "example@domain.com";
          }
        }

        inputElement.className = "edit-input";
        inputElement.id = `edit-${fieldId}`;

        // استبدال span بحقل الإدخال فقط (بدون أزرار)
        const container = document.createElement("div");
        container.className = "edit-container";
        container.appendChild(inputElement);
        span.parentNode.replaceChild(container, span);
        inputElement.focus();
      }

      // دالة حفظ تعديل الحقل
      function saveFieldEdit(fieldId, fieldKey, type) {
        const input = document.getElementById(`edit-${fieldId}`);
        if (!input) return;

        const newValue = input.value.trim();
        const container = input.parentNode;

        // التحقق من صحة البيانات
        if (input.type === "number" && isNaN(newValue)) {
          alert("الرجاء إدخال رقم صحيح");
          return;
        }
        if (input.type === "tel" && !/^[0-9]{10}$/.test(newValue)) {
          alert("الرجاء إدخال رقم جوال صحيح مكون من 10 أرقام");
          return;
        }
        if (
          input.type === "email" &&
          !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newValue)
        ) {
          alert("الرجاء إدخال بريد إلكتروني صحيح");
          return;
        }

        // هنا يمكنك إضافة التحقق من صحة البيانات وإرسالها إلى الخادم

        // إعادة عرض القيمة المحدثة
        const span = document.createElement("span");
        span.id = fieldId;
        span.className = "field-value";
        span.textContent = newValue;

        container.parentNode.replaceChild(span, container);
      }

      // دالة إلغاء التعديل
      function cancelFieldEdit(fieldId, value) {
        const span = document.createElement("span");
        span.id = fieldId;
        span.className = "field-value";
        span.textContent = value;

        const container = document.querySelector(
          `#edit-${fieldId}`
        )?.parentNode;
        if (container) {
          container.parentNode.replaceChild(span, container);
        }
      }

      let rowToDelete = null;
      function deleteStore(btn) {
        rowToDelete = btn.closest("tr");
        document.getElementById("delete-modal-title").textContent =
          "تأكيد الحذف";
        document.getElementById("delete-confirm-message").innerHTML =
          "هل أنت متأكد من حذف هذا السطر؟";
        document.getElementById("delete-confirm-modal").style.display = "block";
      }
      function confirmDelete() {
        if (rowToDelete) rowToDelete.remove();
        closeDeleteModal();
      }
      function closeDeleteModal() {
        document.getElementById("delete-confirm-modal").style.display = "none";
        rowToDelete = null;
      }

      // دالة لحفظ جميع الحقول دفعة واحدة
      function saveAllFieldsEdit(type) {
        const editBtn = document.querySelector(".edit-all-btn");
        const fields = document.querySelectorAll("#viewEditFields .field-row");
        let valid = true;
        fields.forEach((field) => {
          const input = field.querySelector(".edit-input");
          if (input) {
            let newValue = input.value.trim();
            // تحقق من صحة البيانات حسب النوع
            if (input.type === "number" && isNaN(newValue)) {
              alert("الرجاء إدخال رقم صحيح");
              valid = false;
              return;
            }
            if (input.type === "tel" && !/^[0-9]{10}$/.test(newValue)) {
              alert("الرجاء إدخال رقم جوال صحيح مكون من 10 أرقام");
              valid = false;
              return;
            }
            if (
              input.type === "email" &&
              !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newValue)
            ) {
              alert("الرجاء إدخال بريد إلكتروني صحيح");
              valid = false;
              return;
            }
          }
        });
        if (!valid) return;
        // حفظ القيم الجديدة
        fields.forEach((field) => {
          const input = field.querySelector(".edit-input");
          if (input) {
            const fieldId = input.id.replace("edit-", "");
            const span = document.createElement("span");
            span.id = fieldId;
            span.className = "field-value";
            span.textContent = input.value.trim();
            field
              .querySelector(".edit-container")
              .parentNode.replaceChild(
                span,
                field.querySelector(".edit-container")
              );
          }
        });
        // إعادة زر التعديل وإخفاء أزرار الحفظ/الإلغاء
        editBtn.classList.remove("editing");
        editBtn.style.display = "";
        const actionBtns = document.getElementById("edit-actions-bottom");
        if (actionBtns) actionBtns.remove();
      }

      // أضف جافاسكريبت لتفعيل تمييز الزر النشط
      function setActiveBarBtn(btn) {
        document
          .querySelectorAll(".header-bar .bar-btn")
          .forEach((b) => b.classList.remove("active-bar-btn"));
        btn.classList.add("active-bar-btn");
      }
    </script>
  </head>
  <body>
    <!-- Authorization Check -->
    <script>
      // Check authorization before loading the page
      function checkAuthorization() {
        const token = localStorage.getItem("token");
        const userType = localStorage.getItem("user_type");

        // Check if token exists
        if (!token) {
          window.location.href = "../login.html";
          return;
        }

        // Check user type (admin = 4)
        if (userType !== "1") {
          // Create and show unauthorized message
          document.body.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100vh;
              background-color: #f8fafc;
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <i class="fas fa-exclamation-triangle" style="
                font-size: 64px;
                color: #ef4444;
                margin-bottom: 20px;
              "></i>
              <h1 style="
                color: #1e293b;
                font-size: 24px;
                margin-bottom: 16px;
              ">غير مصرح لك بالوصول</h1>
              <p style="
                color: #64748b;
                font-size: 16px;
                margin-bottom: 24px;
              ">عذراً، ليس لديك الصلاحية للوصول إلى هذه الصفحة</p>
              <button onclick="window.location.href='../login.html'" style="
                background-color: #2563eb;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                transition: background-color 0.3s;
              ">العودة إلى صفحة تسجيل الدخول</button>
            </div>
          `;
          return;
        }
      }

      // Run authorization check when page loads
      $(document).ready(function() {
        // checkAuthorization();
      });
    </script>

    <!-- Header Section -->
    <header>
      <div class="container navbar">
        <h1>IEMM</h1>
        <nav>
          <a href="mall-dashboard.html" id="dashboard-link"
            ><i class="fas fa-chart-line"></i> لوحة التحكم</a
          >
          <a href="stores-management.html" id="stores-link" class="active"
            ><i class="fas fa-store"></i> إدارة المحلات</a
          >
          <a href="bills.html" id="bills-link"
            ><i class="fas fa-file-invoice-dollar"></i> الفواتير</a
          >
        </nav>
        <div style="display: flex; align-items: center; gap: 12px">
          <button class="btn-dark convert"></button>
          <!-- <button class="btn-dark " onclick="document.body.classList.toggle('dark')">الوضع الليلي</button> -->

          <button
            id="chat-toggle"
            class="chat-toggle-btn"
            title="الدردشة مع أصحاب المحلات"
          >
            <i class="fas fa-comments"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- نافذة الدردشة الجانبية -->
    <div id="chat-panel" class="chat-panel">
      <!-- قائمة جهات الاتصال -->
      <div id="contacts-view">
        <div class="chat-header">
          <h3>الدردشة مع أصحاب المحلات</h3>
          <button id="chat-close" class="chat-close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="contact-list" class="contact-list">
          <!-- سيتم إنشاء قائمة جهات الاتصال عبر JavaScript -->
        </div>
      </div>

      <!-- نافذة المحادثة -->
      <div id="chat-conversation" class="chat-conversation">
        <div class="conversation-header">
          <button id="back-to-contacts" class="back-to-contacts">
            <i class="fas fa-arrow-right"></i>
          </button>
          <div class="conversation-contact">
            <div id="conversation-avatar" class="conversation-avatar">أ</div>
            <div class="conversation-info">
              <h4 id="conversation-title">أحمد محمد</h4>
              <p id="conversation-store">مطعم الأصالة</p>
            </div>
          </div>
        </div>
        <div id="messages-container" class="messages-container">
          <!-- سيتم إنشاء الرسائل عبر JavaScript -->
        </div>
        <form id="message-form" class="message-form">
          <textarea
            id="message-input"
            class="message-input"
            placeholder="اكتب رسالتك هنا..."
            rows="1"
          ></textarea>
          <button type="submit" class="send-message-btn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <!-- Stores Management Section -->
      <div class="section active" id="stores-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-store"></i> إدارة المحلات
          </h2>
          <div class="header-bar">
            <div class="view-toggle-buttons">
              <button
                class="btn-dark bar-btn active-bar-btn"
                id="table-view-btn"
                onclick="setActiveBarBtn(this); toggleView('table')"
              >
                <i class="fas fa-table"></i>
                عرض الجداول
              </button>
              <button
                class="btn-dark bar-btn"
                id="map-view-btn"
                onclick="setActiveBarBtn(this); toggleView('map')"
              >
                <i class="fas fa-map"></i>
                عرض الخريطة
              </button>
            </div>
            <div class="action-buttons">
              <button
                class="btn-green bar-btn"
                onclick="setActiveBarBtn(this); toggleForm('newStoreForm')"
              >
                <i class="fas fa-plus"></i>
                إضافة مرفق جديد
              </button>
              <button
                class="btn-green"
                onclick="toggleForm('newStoreFormContainer')"
              >
                <i class="fas fa-user-plus"></i>
                إضافة صاحب محل
              </button>
            </div>
          </div>
        </div>
        <!-- نموذج إضافة مرفق جديد -->

        <form
          id="newFacilityFormContainer"
          class="form-container"
          style="display: none"
        >
          <div class="form card">
            <h3>إضافة مرفق جديد</h3>
            <div class="form-grid">
              <input
                type="number"
                name="rant_price"
                id="rant_price"
                placeholder="مبلغ الإيجار"
                required
              />
              <input
                type="text"
                name="electricity_number"
                id="electricity_number"
                placeholder="رقم عداد الكهرباء"
                required
              />
              <input
                type="text"
                name="water_number"
                id="water_number"
                placeholder="رقم عداد الماء"
                required
              />
              <input
                type="number"
                name="floor_number"
                id="floor_number"
                placeholder="رقم الدور"
                required
              />
              <input
                type="number"
                name="X_Coordinates"
                id="X_Coordinates"
                placeholder="الموقع X"
                required
              />
              <input
                type="number"
                name="Y_Coordinates"
                id="Y_Coordinates"
                placeholder="الموقع Y"
                required
              />
              <input
                type="number"
                name="width"
                id="width"
                placeholder="العرض"
                required
              />
              <input
                type="number"
                name="length"
                id="length"
                placeholder="الطول"
                required
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-green">حفظ</button>
              <button
                type="button"
                class="btn-secondary"
                onclick="toggleForm('newFacilityFormContainer')"
              >
                إلغاء
              </button>
            </div>
          </div>
        </form>

        <!-- نموذج إضافة صاحب محل -->
        <form
          id="newStoreFormContainer"
          class="form-container"
          style="display: none"
        >
          <div class="form card">
            <h3>إضافة صاحب محل</h3>

            <!-- قسم بيانات المحل -->
            <div class="form-section">
              <h4>بيانات المحل</h4>
              <div class="form-grid">
                <input
                  type="text"
                  name="shop_name"
                  placeholder="اسم المحل"
                  required
                />
                <input
                  type="text"
                  name="work_times"
                  placeholder="أوقات المحل"
                  required
                />
                <select name="facility_id" required>
                  <option value="">اختر المرفق</option>
                </select>
                <input
                  type="file"
                  name="image"
                  accept="image/jpeg,image/png,image/jpg"
                  required
                />
              </div>
            </div>

            <!-- قسم بيانات صاحب المحل -->
            <div class="form-section">
              <h4>بيانات صاحب المحل</h4>
              <div class="form-grid">
                <input
                  type="text"
                  name="owner_name"
                  placeholder="اسم المستأجر الثنائي"
                  required
                />
                <input
                  type="text"
                  name="username"
                  placeholder="اسم المستخدم"
                  required
                />
                <input
                  type="email"
                  name="email"
                  placeholder="البريد الإلكتروني"
                  required
                />
                <input
                  type="tel"
                  name="phone"
                  placeholder="رقم الهاتف"
                  required
                />
                <input
                  type="password"
                  name="password"
                  placeholder="كلمة السر"
                  required
                />
                <input
                  type="password"
                  name="password_confirmation"
                  placeholder="تأكيد كلمة السر"
                  required
                />
                <select name="sex" required>
                  <option value="">اختر النوع</option>
                  <option value="male">ذكر</option>
                  <option value="female">أنثى</option>
                </select>
                <input
                  type="date"
                  name="birth_date"
                  placeholder="تاريخ الميلاد"
                  required
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-green">حفظ</button>
              <button
                type="button"
                class="btn-secondary"
                onclick="toggleForm('newStoreFormContainer')"
              >
                إلغاء
              </button>
            </div>
          </div>
        </form>

        <!-- جداول البيانات -->
        <div class="tables-container" id="tables-view">
          <div class="table card">
            <div class="list-toggle-bar">
              <button
                class="btn-dark bar-btn active-bar-btn"
                onclick="setActiveBarBtn(this); toggleList('facilities-list')"
              >
                <i class="fas fa-building"></i>
                قائمة المرافق
              </button>
              <button
                class="btn-dark bar-btn"
                onclick="setActiveBarBtn(this); toggleList('tenants-list')"
              >
                <i class="fas fa-users"></i>
                قائمة أصحاب المحلات
              </button>
              <button
                class="btn-dark bar-btn"
                onclick="setActiveBarBtn(this); toggleList('stores-list')"
              >
                <i class="fas fa-store"></i>
                قائمة المحلات
              </button>
            </div>

            <!-- قائمة المرافق -->
            <div id="facilities-list" class="list-section">
              <div class="table-header">
                <h3>قائمة مرافق المول</h3>
                <div class="search-box">
                  <input
                    type="text"
                    class="search-input"
                    placeholder="ابحث في المرافق..."
                    onkeyup="searchTable('facilities-list', this.value)"
                  />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>رقم المرفق</th>
                      <th>الدور</th>
                      <th>المساحة</th>
                      <th>الحالة</th>
                      <th>صاحب المحل</th>
                      <th>اسم المحل</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody class="facilities-table"></tbody>
                </table>
              </div>
            </div>

            <!-- قائمة أصحاب المحلات -->
            <div id="tenants-list" class="list-section" style="display: none">
              <div class="table-header">
                <h3>قائمة أصحاب المحلات</h3>
                <div class="search-box">
                  <input
                    type="text"
                    class="search-input"
                    placeholder="ابحث في أصحاب المحلات..."
                    onkeyup="searchTable('tenants-list', this.value)"
                  />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>رقم الجوال</th>
                      <th>البريد الإلكتروني</th>
                      <th>المحلات المستأجرة</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>

                  <tbody class="owner-table"></tbody>
                </table>
              </div>
            </div>

            <!-- قائمة المحلات -->
            <div id="stores-list" class="list-section" style="display: none">
              <div class="table-header">
                <h3>قائمة المحلات</h3>
                <div class="search-box">
                  <input
                    type="text"
                    class="search-input"
                    placeholder="ابحث في المحلات..."
                    onkeyup="searchTable('stores-list', this.value)"
                  />
                  <i class="fas fa-search search-icon"></i>
                </div>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>اسم المالك</th>
                      <th>اسم المحل</th>
                      <th>النشاط</th>
                      <th>الدور</th>
                      <th>الحالة</th>
                      <th>تاريخ بداية العقد</th>
                      <th>أوقات الدوام</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>

                  <tbody class="stores-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- خريطة المول -->
        <div class="card" id="map-view" style="display: none">
          <h3>خريطة المول</h3>
          <div class="floor-controls">
            <button class="btn-green" onclick="decrementFloor()">-</button>
            <span id="currentFloor">الدور: 0</span>
            <button class="btn-green" onclick="incrementFloor()">+</button>
          </div>
          <div id="mall-map"></div>
        </div>
      </div>
      <!-- نافذة تعديل المحل -->
      <div id="editStoreModal" class="modal">
        <div class="modal-content">
          <h3>تعديل بيانات المحل</h3>
          <form class="form">
            <div class="form-sections">
              <!-- قسم بيانات المحل -->
              <div class="form-section">
                <h4>بيانات المحل</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="edit-store-number">رقم المحل</label>
                    <input
                      type="text"
                      id="edit-store-number"
                      placeholder="رقم المحل"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-area">المساحة</label>
                    <input
                      type="number"
                      id="edit-store-area"
                      placeholder="المساحة"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-activity">النشاط</label>
                    <select id="edit-store-activity" required>
                      <option value="">اختر النشاط</option>
                      <option value="restaurant">مطعم</option>
                      <option value="clothing">ملابس</option>
                      <option value="electronics">إلكترونيات</option>
                      <option value="cosmetics">مستحضرات تجميل</option>
                      <option value="services">خدمات</option>
                      <option value="other">أخرى</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="edit-store-floor">رقم الدور</label>
                    <input
                      type="number"
                      id="edit-store-floor"
                      placeholder="رقم الدور"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-x">الموقع X</label>
                    <input
                      type="number"
                      id="edit-store-x"
                      placeholder="الموقع X"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-y">الموقع Y</label>
                    <input
                      type="number"
                      id="edit-store-y"
                      placeholder="الموقع Y"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-width">العرض</label>
                    <input
                      type="number"
                      id="edit-store-width"
                      placeholder="العرض"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-store-height">الطول</label>
                    <input
                      type="number"
                      id="edit-store-height"
                      placeholder="الطول"
                      required
                    />
                  </div>
                </div>
              </div>

              <!-- قسم بيانات صاحب المحل -->
              <div class="form-section">
                <h4>بيانات صاحب المحل</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="edit-tenant-name">اسم المستأجر</label>
                    <input
                      type="text"
                      id="edit-tenant-name"
                      placeholder="اسم المستأجر"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-tenant-phone">رقم الجوال</label>
                    <input
                      type="tel"
                      id="edit-tenant-phone"
                      placeholder="رقم الجوال"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-tenant-email">البريد الإلكتروني</label>
                    <input
                      type="email"
                      id="edit-tenant-email"
                      placeholder="البريد الإلكتروني"
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-tenant-id">رقم الهوية</label>
                    <input
                      type="text"
                      id="edit-tenant-id"
                      placeholder="رقم الهوية"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-tenant-contract-start"
                      >تاريخ بداية العقد</label
                    >
                    <input
                      type="date"
                      id="edit-tenant-contract-start"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="edit-tenant-contract-end"
                      >تاريخ نهاية العقد</label
                    >
                    <input type="date" id="edit-tenant-contract-end" required />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-green">حفظ التغييرات</button>
              <button
                type="button"
                class="btn-secondary"
                onclick="closeModal('editStoreModal')"
              >
                إلغاء
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- نافذة عرض تفاصيل المحل -->
      <div id="storeDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px">
          <h3 style="margin-bottom: 1.5rem; color: #2563eb; text-align: center">
            تفاصيل المحل والمرفق
          </h3>
          <div
            class="details-sections"
            style="display: flex; flex-direction: column; gap: 1.5rem"
          >
            <!-- بيانات المرفق -->
            <div
              class="details-section"
              style="
                background: #f8fafc;
                border-radius: 10px;
                padding: 1rem 1.5rem;
                box-shadow: 0 1px 4px #e2e8f0;
              "
            >
              <h4 style="color: #22c55e; margin-bottom: 1rem">
                <i class="fas fa-building"></i> بيانات المرفق
              </h4>
              <div
                class="details-grid"
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 0.7rem 1.5rem;
                "
              >
                <div>
                  <span class="detail-label">مبلغ الإيجار:</span>
                  <span id="view-facility-rent"></span>
                </div>
                <div>
                  <span class="detail-label">رقم عداد الماء:</span>
                  <span id="view-facility-water-meter"></span>
                </div>
                <div>
                  <span class="detail-label">رقم عداد الكهرباء:</span>
                  <span id="view-facility-electricity-meter"></span>
                </div>
                <div>
                  <span class="detail-label">العرض:</span>
                  <span id="view-facility-width"></span>
                </div>
                <div>
                  <span class="detail-label">الطول:</span>
                  <span id="view-facility-height"></span>
                </div>
              </div>
            </div>

            <!-- بيانات المحل -->
            <div
              class="details-section"
              style="
                background: #f8fafc;
                border-radius: 10px;
                padding: 1rem 1.5rem;
                box-shadow: 0 1px 4px #e2e8f0;
              "
            >
              <h4 style="color: #3b82f6; margin-bottom: 1rem">
                <i class="fas fa-store"></i> بيانات المحل
              </h4>
              <div
                class="details-grid"
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 0.7rem 1.5rem;
                "
              >
                <div>
                  <span class="detail-label">اسم المحل:</span>
                  <span id="view-store-name"></span>
                </div>
                <div>
                  <span class="detail-label">النشاط:</span>
                  <span id="view-store-activity"></span>
                </div>
                <div>
                  <span class="detail-label">تاريخ بدء العقد:</span>
                  <span id="view-store-contract-start"></span>
                </div>
                <div>
                  <span class="detail-label">أوقات الدوام:</span>
                  <span id="view-store-working-hours"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-actions" style="margin-top: 2rem; text-align: left">
            <button
              class="btn-secondary"
              onclick="closeModal('storeDetailsModal')"
            >
              إغلاق
            </button>
          </div>
        </div>
      </div>
      <!-- نافذة عرض/تعديل ديناميكية -->
      <form>
        <div id="viewEditModal" class="modal">
          <div class="modal-content" style="max-width: 600px">
            <h3
              id="viewEditModalTitle"
              style="margin-bottom: 1.5rem; color: #2563eb; text-align: center"
            ></h3>
            <form id="viewEditForm" class="form">
              <div
                id="viewEditFields"
                class="form-grid"
                style="gap: 1.2rem 1.5rem"
              ></div>
              <div
                class="form-actions"
                style="margin-top: 2rem; text-align: left"
              >
                <button
                  type="button"
                  class="btn-secondary"
                  onclick="closeModal('viewEditModal')"
                >
                  إغلاق
                </button>
              </div>
            </form>
            </div>
          </div>
        </form>

        <!-- نافذة عرض/تعديل ديناميكية
        <div id="viewEditModal" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <h3 id="viewEditModalTitle" style="margin-bottom: 1.5rem; color: #2563eb; text-align: center;"></h3>
            <form id="viewEditForm" class="form">
              <div id="viewEditFields" class="form-grid" style="gap: 1.2rem 1.5rem;"></div>
              <div class="form-actions" style="margin-top: 2rem; text-align: left;">
                <button type="button" class="btn-secondary" onclick="closeModal('viewEditModal')">إغلاق</button>
                </div>
            </form>
                </div>
        </div> -->

        <!-- نافذة تأكيد الحذف -->
        <div id="delete-confirm-modal" class="modal" style="display:none;">
          <div class="modal-content" style="max-width: 400px;">
            <span class="close-modal" onclick="closeDeleteModal()">&times;</span>
            <h3 id="delete-modal-title">تأكيد الحذف</h3>
            <div class="delete-message" style="text-align: center; margin: 20px 0;">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 3em; margin-bottom: 15px;"></i>
              <p id="delete-confirm-message" style="color: #4b5563; font-size: 1.1em; line-height: 1.5;">هل أنت متأكد من حذف هذا السطر؟</p>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="confirmDelete()">حذف</button>
              <button type="button" class="btn-green" onclick="closeDeleteModal()">إلغاء</button>
            </div>
          </div>
        </div>
      </form>

      <!-- نافذة عرض/تعديل ديناميكية -->
      <div id="viewEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px">
          <h3
            id="viewEditModalTitle"
            style="margin-bottom: 1.5rem; color: #2563eb; text-align: center"
          ></h3>
          <form id="viewEditForm" class="form">
            <div
              id="viewEditFields"
              class="form-grid"
              style="gap: 1.2rem 1.5rem"
            ></div>
            <div
              class="form-actions"
              style="margin-top: 2rem; text-align: left"
            >
              <button
                type="button"
                class="btn-secondary"
                onclick="closeModal('viewEditModal')"
              >
                إغلاق
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- نافذة تأكيد الحذف -->
      <div id="delete-confirm-modal" class="modal" style="display: none">
        <div class="modal-content" style="max-width: 400px">
          <span class="close-modal" onclick="closeDeleteModal()">&times;</span>
          <h3 id="delete-modal-title">تأكيد الحذف</h3>
          <div
            class="delete-message"
            style="text-align: center; margin: 20px 0"
          >
            <i
              class="fas fa-exclamation-triangle"
              style="color: #f59e0b; font-size: 3em; margin-bottom: 15px"
            ></i>
            <p
              id="delete-confirm-message"
              style="color: #4b5563; font-size: 1.1em; line-height: 1.5"
            >
              هل أنت متأكد من حذف هذا السطر؟
            </p>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="confirmDelete()"
            >
              حذف
            </button>
            <button
              type="button"
              class="btn-green"
              onclick="closeDeleteModal()"
            >
              إلغاء
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="../views/js/mall-management/index.js"></script>

    <script src="../views/js/mall-management/sotores-management.js"></script>

    <script>
      function toggleForm(formId) {
        const form = document.getElementById(formId);
        const allForms = document.querySelectorAll(".form-container");
        const tablesContainer = document.getElementById("tables-view");

        if (form.style.display === "block") {
          form.style.display = "none";
          tablesContainer.style.display = "block";
          return;
        }

        allForms.forEach((f) => (f.style.display = "none"));
        form.style.display = "block";
        tablesContainer.style.display = "none";
      }

      function toggleList(listId) {
        // تحديث حالة الأزرار
        const buttons = document.querySelectorAll(".list-toggle-bar .btn-dark");
        buttons.forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        // إخفاء جميع القوائم
        const lists = document.querySelectorAll(".list-section");
        lists.forEach((list) => (list.style.display = "none"));

        // إظهار القائمة المطلوبة
        document.getElementById(listId).style.display = "block";

        if (typeof StoreManagement === "function") {
          window.storeManagement = new StoreManagement();
        }
      }

      // تهيئة القوائم عند تحميل الصفحة
      document.addEventListener("DOMContentLoaded", function () {
        // إظهار قائمة المرافق افتراضياً
        document
          .querySelector(".list-toggle-bar .btn-dark")
          .classList.add("active");
        document.getElementById("facilities-list").style.display = "block";
      });

      function searchTable(listId, searchText) {
        const table = document.querySelector(`#${listId} table`);
        const rows = table.getElementsByTagName("tr");

        // تحويل نص البحث إلى حروف صغيرة
        searchText = searchText.toLowerCase();

        // بدء من الصف الثاني (تخطي رأس الجدول)
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const cells = row.getElementsByTagName("td");
          let found = false;

          // البحث في كل خلية في الصف
          for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell.textContent.toLowerCase().indexOf(searchText) > -1) {
              found = true;
              break;
            }
          }

          // إظهار أو إخفاء الصف بناءً على نتيجة البحث
          row.style.display = found ? "" : "none";
        }
      }

      // دالة مساعدة لإنشاء صف من الحقول
      function createFieldRow(fields, data) {
        return fields
          .map((field) => {
            const value = data[field.key] || "";
            const fieldId = `view-field-${field.key}`;
            return `
        <div class="field-row">
          <label>${field.label}</label>
          <span id="${fieldId}" class="field-value">${
              field.type === "date" && value ? value.split("T")[0] : value
            }</span>
        </div>
        `;
          })
          .join("");
      }

      // دالة مساعدة للحصول على نوع الحقل
      function getFieldType(key, type) {
        const fieldTypes = {
          facilities: {
            rent: "number",
            waterMeter: "text",
            electricityMeter: "text",
            floor: "text",
            x: "number",
            y: "number",
            width: "number",
            height: "number",
          },
          tenants: {
            name: "text",
            phone: "tel",
            email: "email",
            stores: "text",
            gender: "select",
            birthdate: "date",
          },
          stores: {
            owner: "text",
            storeName: "text",
            activity: "text",
            contractStart: "date",
            workingHours: "text",
          },
        };
        return fieldTypes[type][key] || "text";
      }

      // دالة تفعيل تعديل حقل معين
      function enableFieldEdit(fieldId, fieldKey, fieldType, type) {
        const span = document.getElementById(fieldId);
        if (!span) return;

        const currentValue = span.textContent.trim();

        let inputElement;
        if (fieldType === "select") {
          inputElement = document.createElement("select");
          if (fieldKey === "gender") {
            inputElement.innerHTML = `
                  <option value="male" ${
                    currentValue === "ذكر" ? "selected" : ""
                  }>ذكر</option>
                  <option value="female" ${
                    currentValue === "أنثى" ? "selected" : ""
                  }>أنثى</option>
              `;
          }
        } else {
          inputElement = document.createElement("input");
          inputElement.type = fieldType;
          inputElement.value = currentValue;

          // إضافة خصائص إضافية حسب نوع الحقل
          if (fieldType === "number") {
            inputElement.min = "0";
            inputElement.step = "any";
          }
          if (fieldType === "tel") {
            inputElement.pattern = "[0-9]{10}";
            inputElement.placeholder = "05XXXXXXXX";
          }
          if (fieldType === "email") {
            inputElement.placeholder = "example@domain.com";
          }
        }

        inputElement.className = "edit-input";
        inputElement.id = `edit-${fieldId}`;

        // استبدال span بحقل الإدخال فقط (بدون أزرار)
        const container = document.createElement("div");
        container.className = "edit-container";
        container.appendChild(inputElement);
        span.parentNode.replaceChild(container, span);
        inputElement.focus();
      }

      // دالة حفظ تعديل الحقل
      function saveFieldEdit(fieldId, fieldKey, type) {
        const input = document.getElementById(`edit-${fieldId}`);
        if (!input) return;

        const newValue = input.value.trim();
        const container = input.parentNode;

        // التحقق من صحة البيانات
        if (input.type === "number" && isNaN(newValue)) {
          alert("الرجاء إدخال رقم صحيح");
          return;
        }
        if (input.type === "tel" && !/^[0-9]{10}$/.test(newValue)) {
          alert("الرجاء إدخال رقم جوال صحيح مكون من 10 أرقام");
          return;
        }
        if (
          input.type === "email" &&
          !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newValue)
        ) {
          alert("الرجاء إدخال بريد إلكتروني صحيح");
          return;
        }

        // هنا يمكنك إضافة التحقق من صحة البيانات وإرسالها إلى الخادم

        // إعادة عرض القيمة المحدثة
        const span = document.createElement("span");
        span.id = fieldId;
        span.className = "field-value";
        span.textContent = newValue;

        container.parentNode.replaceChild(span, container);
      }

      // دالة إلغاء التعديل
      function cancelFieldEdit(fieldId, value) {
        const span = document.createElement("span");
        span.id = fieldId;
        span.className = "field-value";
        span.textContent = value;

        const container = document.querySelector(
          `#edit-${fieldId}`
        )?.parentNode;
        if (container) {
          container.parentNode.replaceChild(span, container);
        }
      }

      function confirmDelete() {
        if (rowToDelete) rowToDelete.remove();
        closeDeleteModal();
      }
      function closeDeleteModal() {
        document.getElementById("delete-confirm-modal").style.display = "none";
        rowToDelete = null;
      }

      // دالة لحفظ جميع الحقول دفعة واحدة
      function saveAllFieldsEdit(type) {
        const editBtn = document.querySelector(".edit-all-btn");
        const fields = document.querySelectorAll("#viewEditFields .field-row");
        let valid = true;
        fields.forEach((field) => {
          const input = field.querySelector(".edit-input");
          if (input) {
            let newValue = input.value.trim();
            // تحقق من صحة البيانات حسب النوع
            if (input.type === "number" && isNaN(newValue)) {
              alert("الرجاء إدخال رقم صحيح");
              valid = false;
              return;
            }
            if (input.type === "tel" && !/^[0-9]{10}$/.test(newValue)) {
              alert("الرجاء إدخال رقم جوال صحيح مكون من 10 أرقام");
              valid = false;
              return;
            }
            if (
              input.type === "email" &&
              !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newValue)
            ) {
              alert("الرجاء إدخال بريد إلكتروني صحيح");
              valid = false;
              return;
            }
          }
        });
        if (!valid) return;
        // حفظ القيم الجديدة
        fields.forEach((field) => {
          const input = field.querySelector(".edit-input");
          if (input) {
            const fieldId = input.id.replace("edit-", "");
            const span = document.createElement("span");
            span.id = fieldId;
            span.className = "field-value";
            span.textContent = input.value.trim();
            field
              .querySelector(".edit-container")
              .parentNode.replaceChild(
                span,
                field.querySelector(".edit-container")
              );
          }
        });
        // إعادة زر التعديل وإخفاء أزرار الحفظ/الإلغاء
        editBtn.classList.remove("editing");
        editBtn.style.display = "";
        const actionBtns = document.getElementById("edit-actions-bottom");
        if (actionBtns) actionBtns.remove();
      }

      // أضف جافاسكريبت لتفعيل تمييز الزر النشط
      function setActiveBarBtn(btn) {
        document
          .querySelectorAll(".header-bar .bar-btn")
          .forEach((b) => b.classList.remove("active-bar-btn"));
        btn.classList.add("active-bar-btn");
      }
    </script>
  </body>
</html>
