<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IEMM - الفواتير</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../views/css/styles.css" />
    <link rel="stylesheet" href="../views/css/chat.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="../views/js/script.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../views/js/theme-manager.js" defer></script>
    <script src="../views/js/stores/chat.js" defer></script>
    <style>
      /* تنسيقات الجداول مع التمرير */
      .table-wrapper {
        /* max-height: 400px; */
        overflow-y: visible;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
      }

      .table-wrapper table {
        width: 100%;
        border-collapse: collapse;
      }

      .table-wrapper thead {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }

      .table-wrapper th {
        padding: 12px;
        text-align: right;
        font-weight: 600;
        color: #1e293b;
        border-bottom: 2px solid #e2e8f0;
      }

      .table-wrapper td {
        padding: 12px;
        text-align: right;
        border-bottom: 1px solid #e2e8f0;
      }

      /* تنسيقات البحث والفلترة */
      .table-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        align-items: center;
      }

      .search-box {
        position: relative;
        flex: 1;
      }

      .search-box input {
        width: 100%;
        padding: 8px 12px;
        padding-right: 35px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .search-box i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
      }

      .filter-controls {
        display: flex;
        gap: 8px;
      }

      .filter-controls select {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        min-width: 120px;
      }

      /* Dark Mode Styles */
      body.dark .table-wrapper {
        border-color: #334155;
      }

      body.dark .table-wrapper thead {
        background: var(--dark-chart);
      }

      body.dark .table-wrapper th {
        color: var(--dark-text);
        border-bottom-color: #334155;
      }

      body.dark .table-wrapper td {
        border-bottom-color: #334155;
        color: var(--dark-text);
      }

      body.dark .search-box input {
        background: var(--dark-card);
        color: var(--dark-text);
        border-color: #334155;
      }

      body.dark .search-box i {
        color: #94a3b8;
      }

      body.dark .filter-controls select {
        background: var(--dark-card);
        color: var(--dark-text);
        border-color: #334155;
      }
    </style>
  </head>
  <body>
    <!-- Authorization Check -->
     <script>
      // Check authorization before loading the page
      function checkAuthorization() {
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('user_type');
        
        // Check if token exists
        if (!token) {
          window.location.href = '../login.html';
          return;
        }

        // Check user type (admin = 4)
        if (userType !== '2') {
          // Create and show unauthorized message
          document.body.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100vh;
              background-color: #f8fafc;
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <i class="fas fa-exclamation-triangle" style="
                font-size: 64px;
                color: #ef4444;
                margin-bottom: 20px;
              "></i>
              <h1 style="
                color: #1e293b;
                font-size: 24px;
                margin-bottom: 16px;
              ">غير مصرح لك بالوصول</h1>
              <p style="
                color: #64748b;
                font-size: 16px;
                margin-bottom: 24px;
              ">عذراً، ليس لديك الصلاحية للوصول إلى هذه الصفحة</p>
              <button onclick="window.location.href='../login.html'" style="
                background-color: #2563eb;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                transition: background-color 0.3s;
              ">العودة إلى صفحة تسجيل الدخول</button>
            </div>
          `;
          return;
        }

        // Verify token with backend
        
      }

      // Run authorization check when page loads
      $(document).ready(function() {
        checkAuthorization();
            const isOwner = localStorage.getItem("is_owner") == "true";
        const staffLink = document.getElementById("staff-link");
        if (staffLink) {
          staffLink.style.display = isOwner ? "block" : "none";
        }
      });
    </script>
    

    <!-- Header Section -->
    <header>
      <div class="container navbar">
        <h1>IEMM</h1>
        <nav>
          <a href="shop-dashboard.html" id="dashboard-link"
            ><i class="fas fa-chart-line"></i> لوحة التحكم</a
          >
          <a href="products-management.html" id="products-link"
            ><i class="fas fa-shopping-bag"></i> إدارة المنتجات</a
          >
          <a href="inventory.html" id="inventory-link"
            ><i class="fas fa-box"></i> المخزون</a
          >
          <a href="employees.html" id="staff-link"
            ><i class="fas fa-users"></i> إدارة العاملين</a
          >
          <a href="bills-stores.html" id="bills-link" class="active"
            ><i class="fas fa-file-invoice-dollar"></i> الفواتير</a
          >
        </nav>
        <div style="display: flex; align-items: center; gap: 12px">
          <button class="btn-dark convert"></button>
          <!-- <button class="btn-dark " onclick="document.body.classList.toggle('dark')">الوضع الليلي</button> -->
          <button
            id="chat-toggle"
            class="chat-toggle-btn"
            title="الدردشة مع مدير المول"
          >
            <i class="fas fa-comments"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- نافذة الدردشة الجانبية -->
    <div id="chat-panel" class="chat-panel">
      <div class="chat-header">
        <div class="mall-logo-container">
          <img id="mall-logo" alt="شعار المول" class="mall-logo" />
          <h3>الدردشة مع مدير المول</h3>
        </div>
        <button id="chat-close" class="chat-close-btn">
          <i class="fas fa-times"></i>
                </button>
      </div>
    </div>
  </header>

    <!-- نافذة الدردشة الجانبية -->
    <div id="chat-panel" class="chat-panel">
      <div class="chat-header">
        <div class="mall-logo-container">
          <img id="mall-logo" alt="شعار المول" class="mall-logo" />
          <h3>الدردشة مع مدير المول</h3>
        </div>
        <button id="chat-close" class="chat-close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="messages-container" class="messages-container">
        <!-- سيتم إنشاء الرسائل عبر JavaScript -->
      </div>
      <form id="message-form" class="message-form">
        <textarea
          id="message-input"
          class="message-input"
          placeholder="اكتب رسالتك هنا..."
          rows="1"
        ></textarea>
        <button type="submit" class="send-message-btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Top Action Bar -->
    <div class="top-action-bar">
      <div class="action-group-left">
        <button class="action-btn btn-green" id="new-sale-btn">
          <i class="fas fa-plus"></i>
          عملية بيع جديدة
        </button>
      </div>
      <div class="action-group-right">
        <button class="action-btn btn-gray" id="show-sales-btn">
          <i class="fas fa-table"></i>
          عرض سجل المبيعات
        </button>
        <button class="action-btn btn-blue" id="show-bills-btn">
          <i class="fas fa-file-invoice-dollar"></i>
          عرض الفواتير
        </button>
      </div>
      </div>

    <!-- New Sale Section -->
    <div id="new-sale-section" style="display: none;">
      <div class="card">
        <div class="quick-sale-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3>عملية بيع جديدة</h3>
          <button class="action-btn btn-green" id="new-sale-action-btn" type="button" style="min-width: 140px;">
            <i class="fas fa-plus"></i>
            عملية جديدة
          </button>
                </div>
        <div id="new-sale-form" class="new-sale-form">
                  <div class="form-header">
                    <div class="sale-info">
                      <div class="info-row">
                        <span>رقم العملية:</span>
                        <span id="sale-number">#12345</span>
                      </div>
                      <div class="info-row">
                        <span>التاريخ:</span>
                        <span id="sale-date"></span>
                      </div>
                    </div>
                    <button class="btn-icon" onclick="closeNewSaleForm()">×</button>
                  </div>
                  <div class="form-content">
                    <div class="sale-grid">
                      <div class="product-input-section">
                        <div class="input-group">
                          <label>الباركود</label>
                          <input type="text" id="barcode-input" placeholder="مسح الباركود..." autocomplete="off">
                        </div>
                        <div class="input-group">
                          <label>اسم المنتج</label>
                          <input type="text" id="product-name" list="products-list" placeholder="ابدأ بكتابة اسم المنتج..." autocomplete="off" oninput="validateProductInput()">
                          <datalist id="products-list">
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                          </datalist>
                          <div id="product-error" style="color:red; font-size:0.9em; display:none;">المنتج غير موجود في القائمة</div>
                        </div>
                        <div class="input-group">
                          <label>الكمية</label>
                          <input type="number" id="product-quantity" min="1" value="1">
                        </div>
                        <button class="btn-green" onclick="addProductToSale()">إضافة</button>
                      </div>

                        <div class="invoice-section">
                          <div class="invoice-table">
                            <table>
                              <thead>
                                <tr>
                                  <th>اسم المنتج</th>
                                  <th>الباركود</th>
                                  <th>السعر</th>
                                  <th>الكمية</th>
                                  <th>الإجمالي</th>
                                  <th>حذف</th>
                                </tr>
                              </thead>
                              <tbody id="selected-products-list"></tbody>
                            </table>
                          </div>

                          <div class="invoice-summary card">
                            <h4>ملخص الفاتورة</h4>
                            <div class="summary-grid">
                              <div class="summary-item">
                                <span class="summary-label"
                                  ><i class="fas fa-box"></i> عدد
                                  المنتجات:</span
                                >
                                <span class="summary-value" id="products-count"
                                  >0</span
                                >
                              </div>
                              <div class="summary-item">
                                <span class="summary-label"
                                  ><i class="fas fa-calculator"></i> إجمالي
                                  المنتجات:</span
                                >
                                <span class="summary-value" id="subtotal"
                                  >0.00 ريال</span
                                >
                              </div>
                              <div class="summary-item">
                                <span class="summary-label"
                                  ><i class="fas fa-percent"></i> الخصم:</span
                                >
                                <div class="discount-input">
                                  <input
                                    type="number"
                                    id="discount"
                                    value="0"
                                    min="0"
                                    onchange="updateBillSummary()"
                                    class="form-control"
                                  />
                                  <span class="currency">ريال</span>
                                </div>
                              </div>
                              <div class="summary-item">
                                <span class="summary-label"
                                  ><i class="fas fa-percent"></i> الضريبة:</span
                                >
                                <div class="discount-input">
                                  <input
                                    type="number"
                                    id="tax"
                                    value="0"
                                    min="0"
                                    onchange="updateBillSummary()"
                                    class="form-control"
                                  />
                                  <span class="currency">ريال</span>
                                </div>
                              </div>
                              <div class="summary-item total">
                                <span class="summary-label"
                                  ><i class="fas fa-money-bill-wave"></i>
                                  الإجمالي النهائي:</span
                                >
                                <span class="summary-value highlight" id="total"
                                  >0.00 ريال</span
                                >
                              </div>
                            </div>
                          </div>

                        <div class="payment-section">
                          <div class="payment-method">
                            <label>طريقة الدفع:</label>
                            <select id="payment-method">
                              <option value="نقدي">نقدي</option>
                              <option value="بطاقة">بطاقة</option>
                              <option value="تحويل">تحويل</option>
                            </select>
                          </div>
                          <div class="sale-type">
                            <label>نوع العملية:</label>
                            <select id="sale-type">
                              <option value="بيع">بيع</option>
                              <option value="حجز">حجز</option>
                            </select>
                          </div>
                          <div class="form-actions">
                            <button class="btn-secondary" onclick="closeNewSaleForm()">إلغاء</button>
                            <button type="button" class="btn-green" onclick="completeSale()">تأكيد البيع</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

    <!-- Sales Table Section -->
    <div id="sales-table-section" style="display: none;">
      <div class="card">
        <h3>سجل المبيعات</h3>
          <div class="table-wrapper">
          <div class="table-controls">
            <!-- تم حذف البحث الخارجي، البحث الآن فقط في رأس الجدول -->
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>رقم العملية</th>
                  <th>التاريخ</th>
                  <th>الموظف</th>
                  <th>عدد المنتجات</th>
                  <th>النوع</th>
                  <th>المبلغ الإجمالي</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr class="filter-row">
                  <td>
                    <input type="text" id="sales-search" placeholder="بحث..." class="table-filter-input" style="width: 100px;">
                  </td>
                  <td>
                    <input type="date" id="sales-date-filter" class="table-filter-input">
                  </td>
                  <td>
                    <select id="sales-employee-filter" class="table-filter-input">
                      <option value="all">الكل</option>
                    </select>
                  </td>
                  <td></td>
                  <td>
                    <select id="sales-type-filter" class="table-filter-input">
                      <option value="all">الكل</option>
                      <option value="بيع">بيع</option>
                      <option value="حجز">حجز</option>
                    </select>
                  </td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
              <tbody id="sales-table-body">
                <!-- سيتم ملؤها بواسطة JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
          </div>
        </div>

    <!-- Bills Table Section -->
    <div id="bills-table-section" style="display: none;">
      <div class="card">
        <h3>الفواتير الواردة</h3>
        <div class="table-wrapper">
          <div class="table-controls">
              <!-- تم حذف فلاتر الشهر والحالة خارج الجدول -->
          </div>
          <div class="table-scroll">
            <table>
               <thead>
                 <tr>
                   <th>الكهرباء</th>
                   <th>الماء</th>
                   <th>الإيجار</th>
                   <th>الشهر</th>
                   <th>المتأخرات</th>
                   <th>الإجمالي</th>
                   <th>الإجراءات</th>
                 </tr>
               </thead>
               <tbody>
                 <tr class="filter-row">
                   <td colspan="3"></td>
                   <td>
                     <select id="bills-month-filter" class="table-filter-input">
                       <option value="all">الكل</option>
                     </select>
                   </td>
                   <td>
                     <select id="bills-overdue-filter" class="table-filter-input">
                       <option value="all">الكل</option>
                       <option value="no">لا يوجد متأخرات</option>
                       <option value="yes">عليه متأخرات</option>
                     </select>
                   </td>
                   <td>
                     <select id="bills-total-payment-filter" class="table-filter-input">
                       <option value="all">الكل</option>
                       <option value="paid">مدفوع</option>
                       <option value="unpaid">غير مدفوع</option>
                     </select>
                   </td>
                   <td></td>
                 </tr>
               </tbody>
               <tbody id="incoming-bills-table-body">
                 <!-- سيتم ملؤها بواسطة JavaScript -->
               </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- نافذة عرض تفاصيل الفاتورة -->
    <div id="billDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>تفاصيل الفاتورة</h3>
          <button class="close-modal" onclick="closeBillDetailsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="bill-details-grid">
            <div class="detail-group" id="bill-info">
              <div class="detail-group-header">
                <h4>معلومات الفاتورة</h4>
                <button
                  class="btn-icon edit-section"
                  onclick="toggleBillEditMode('bill-info')"
                  title="تعديل"
                >
                  <i class="fas fa-edit"></i>
                </button>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">رقم الفاتورة:</span>
                  <span id="bill-id" class="detail-value"></span>
                  <input
                    type="text"
                    id="edit-bill-id"
                    class="edit-input"
                    style="display: none"
                    readonly
                  />
                </div>
                <div class="detail-item">
                  <span class="detail-label">التاريخ:</span>
                  <span id="bill-date" class="detail-value"></span>
                  <input
                    type="date"
                    id="edit-bill-date"
                    class="edit-input"
                    style="display: none"
                  />
                </div>
                <div class="detail-item">
                  <span class="detail-label">نوع الفاتورة:</span>
                  <span id="bill-type" class="detail-value"></span>
                  <select
                    id="edit-bill-type"
                    class="edit-input"
                    style="display: none"
                  >
                    <option value="إيجار">إيجار</option>
                    <option value="خدمات">خدمات</option>
                    <option value="صيانة">صيانة</option>
                    <option value="أخرى">أخرى</option>
                  </select>
                </div>
              </div>
              <div
                class="edit-actions"
                id="bill-info-actions"
                style="display: none"
              >
                <button
                  class="btn-green"
                  onclick="saveBillSectionChanges('bill-info')"
                >
                  <i class="fas fa-save"></i> حفظ
                </button>
                <button
                  class="btn-secondary"
                  onclick="cancelBillEditMode('bill-info')"
                >
                  <i class="fas fa-times"></i> إلغاء
                </button>
              </div>
            </div>

            <div class="detail-group" id="payment-info">
              <div class="detail-group-header">
                <h4>معلومات الدفع</h4>
                <button
                  class="btn-icon edit-section"
                  onclick="toggleBillEditMode('payment-info')"
                  title="تعديل"
                >
                  <i class="fas fa-edit"></i>
                </button>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">المبلغ:</span>
                  <span id="bill-amount" class="detail-value"></span>
                  <input
                    type="number"
                    id="edit-bill-amount"
                    class="edit-input"
                    style="display: none"
                  />
                </div>
                <div class="detail-item">
                  <span class="detail-label">تاريخ الاستحقاق:</span>
                  <span id="bill-due-date" class="detail-value"></span>
                  <input
                    type="date"
                    id="edit-bill-due-date"
                    class="edit-input"
                    style="display: none"
                  />
                </div>
                <div class="detail-item">
                  <span class="detail-label">الحالة:</span>
                  <span id="bill-status" class="detail-value"></span>
                  <select
                    id="edit-bill-status"
                    class="edit-input"
                    style="display: none"
                  >
                    <option value="معلقة">معلقة</option>
                    <option value="مدفوعة">مدفوعة</option>
                    <option value="متأخرة">متأخرة</option>
                  </select>
                </div>
              </div>
              <div
                class="edit-actions"
                id="payment-info-actions"
                style="display: none"
              >
                <button
                  class="btn-green"
                  onclick="saveBillSectionChanges('payment-info')"
                >
                  <i class="fas fa-save"></i> حفظ
                </button>
                <button
                  class="btn-secondary"
                  onclick="cancelBillEditMode('payment-info')"
                >
                  <i class="fas fa-times"></i> إلغاء
                </button>
              </div>
            </div>

            <div class="detail-group" id="additional-info">
              <div class="detail-group-header">
                <h4>معلومات إضافية</h4>
                <button
                  class="btn-icon edit-section"
                  onclick="toggleBillEditMode('additional-info')"
                  title="تعديل"
                >
                  <i class="fas fa-edit"></i>
                </button>
              </div>
              <div class="detail-item">
                <span class="detail-label">ملاحظات:</span>
                <span id="bill-notes" class="detail-value"></span>
                <textarea
                  id="edit-bill-notes"
                  class="edit-input"
                  style="display: none"
                ></textarea>
              </div>
              <div
                class="edit-actions"
                id="additional-info-actions"
                style="display: none"
              >
                <button
                  class="btn-green"
                  onclick="saveBillSectionChanges('additional-info')"
                >
                  <i class="fas fa-save"></i> حفظ
                </button>
                <button
                  class="btn-secondary"
                  onclick="cancelBillEditMode('additional-info')"
                >
                  <i class="fas fa-times"></i> إلغاء
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة عرض تفاصيل عملية البيع -->
    <div id="saleDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>تفاصيل عملية البيع</h3>
          <button class="close-modal" onclick="closeSaleDetailsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="sale-details-grid">
            <div class="detail-group">
              <div class="detail-group-header">
                <h4>معلومات العملية</h4>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">رقم العملية:</span>
                  <span id="sale-detail-id" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">التاريخ:</span>
                  <span id="sale-detail-date" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">الموظف:</span>
                  <span id="sale-detail-employee" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">نوع العملية:</span>
                  <span id="sale-detail-type" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">طريقة الدفع:</span>
                  <span id="sale-detail-payment" class="detail-value"></span>
                </div>
              </div>
            </div>

          <div class="detail-group">
            <div class="detail-group-header">
              <h4>المنتجات</h4>
              <button class="btn-icon edit-section" onclick="toggleProductsEditMode()" title="تعديل">
                <i class="fas fa-edit"></i>
              </button>
            </div>
            <div class="products-table">
              <table>
                <thead>
                  <tr>
                    <th>المنتج</th>
                    <th>الباركود</th>
                    <th>السعر</th>
                    <th>الكمية</th>
                    <th>الإجمالي</th>
                    <th class="edit-column" style="display: none;">الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="sale-detail-products">
                </tbody>
              </table>
            </div>
            <div class="edit-actions" id="products-edit-actions" style="display: none;">
              <button class="btn-green" onclick="saveProductsChanges()">
                <i class="fas fa-save"></i> حفظ
              </button>
              <button class="btn-secondary" onclick="cancelProductsEdit()">
                <i class="fas fa-times"></i> إلغاء
              </button>
            </div>
          </div>

            <div class="detail-group">
              <div class="detail-group-header">
                <h4>ملخص الفاتورة</h4>
              </div>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="summary-label">عدد المنتجات:</span>
                  <span
                    id="sale-detail-products-count"
                    class="summary-value"
                  ></span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">إجمالي المنتجات:</span>
                  <span id="sale-detail-subtotal" class="summary-value"></span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">الخصم:</span>
                  <span id="sale-detail-discount" class="summary-value"></span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">الضريبة:</span>
                  <span id="sale-detail-tax" class="summary-value"></span>
                </div>
                <div class="summary-item total">
                  <span class="summary-label">الإجمالي النهائي:</span>
                  <span id="sale-detail-total" class="summary-value"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeSaleDetailsModal()">
            إغلاق
          </button>
          <button class="btn-green" onclick="printSaleFromModal()">
            <i class="fas fa-print"></i> طباعة الفاتورة
          </button>
        </div>
      </div>
    </div>

    <!-- نافذة عرض تفاصيل الفاتورة الواردة -->
    <div id="incomingBillDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>تفاصيل الفاتورة الواردة</h3>
          <button class="close-modal" onclick="closeIncomingBillDetailsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="bill-details-grid">
            <div class="detail-group">
              <div class="detail-group-header">
                <h4>معلومات المحل</h4>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">اسم المحل:</span>
                  <span id="store-name" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">اسم صاحب المحل:</span>
                  <span id="store-owner" class="detail-value"></span>
                </div>
              </div>
            </div>

            <div class="detail-group">
              <div class="detail-group-header">
                <h4>فاتورة الكهرباء</h4>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">مبلغ الشهر الحالي:</span>
                  <span id="current-electricity" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">المتأخرات:</span>
                  <span id="overdue-electricity" class="detail-value"></span>
                </div>
                <div class="detail-item total">
                  <span class="detail-label">الإجمالي:</span>
                  <span id="total-electricity" class="detail-value"></span>
                </div>
              </div>
            </div>

            <div class="detail-group">
              <div class="detail-group-header">
                <h4>فاتورة الماء</h4>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">مبلغ الشهر الحالي:</span>
                  <span id="current-water" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">المتأخرات:</span>
                  <span id="overdue-water" class="detail-value"></span>
                </div>
                <div class="detail-item total">
                  <span class="detail-label">الإجمالي:</span>
                  <span id="total-water" class="detail-value"></span>
                </div>
              </div>
            </div>

            <div class="detail-group">
              <div class="detail-group-header">
                <h4>الإيجار</h4>
              </div>
              <div class="info-grid">
                <div class="detail-item">
                  <span class="detail-label">مبلغ الشهر الحالي:</span>
                  <span id="current-rent" class="detail-value"></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">المتأخرات:</span>
                  <span id="overdue-rent" class="detail-value"></span>
                </div>
                <div class="detail-item total">
                  <span class="detail-label">الإجمالي:</span>
                  <span id="total-rent" class="detail-value"></span>
                </div>
              </div>
            </div>

          <div class="detail-group">
            <div class="detail-group-header">
              <h4>إجمالي الفاتورة</h4>
            </div>
            <div class="summary-grid">
              <div class="summary-item total">
                <span class="summary-label">الإجمالي الكلي:</span>
                <span id="total-bill" class="summary-value"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeIncomingBillDetailsModal()">إغلاق</button>
        <button class="btn-green" onclick="printIncomingBill()">
          <i class="fas fa-print"></i> طباعة الفاتورة
        </button>
      </div>
    </div>
  </div>

  <!-- CSS لتنسيق قسم الفواتير -->
  <style>
    .bills-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .filter-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #fff;
      color: #1e293b;
    }

    .filter-controls select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Dark Mode Styles */
    body.dark .filter-controls select {
      background: var(--dark-chart);
      color: var(--dark-text);
      border-color: #334155;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-badge.pending {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .status-badge.paid {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    .status-badge.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    body.dark .status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    body.dark .status-badge.paid {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    body.dark .status-badge.overdue {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    /* تنسيقات نموذج المبيعات */
    .new-sale-form {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-top: 20px;
      overflow: hidden;
      width: 100%;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .sale-info {
      display: flex;
      gap: 20px;
    }

    .info-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 16px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-content {
      padding: 20px;
    }

    .sale-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
      min-height: 500px;
    }

    .product-input-section {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: fit-content;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-group label {
      font-size: 0.9rem;
      color: #64748b;
      font-weight: 500;
    }

    .input-group input {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      height: 42px;
      width: 100%;
      transition: all 0.2s;
    }

    .input-group input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .invoice-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .invoice-table {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      flex: 1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .invoice-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .invoice-table th,
    .invoice-table td {
      padding: 12px 16px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.95rem;
    }

    .invoice-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
      white-space: nowrap;
    }

    .invoice-table tbody tr:hover {
      background: #f8fafc;
    }

    .invoice-summary {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .summary-item.total {
      grid-column: 1 / -1;
      background: #4a74ff;
      color: #fff;
      padding: 16px;
    }

    .summary-item.total .summary-label,
    .summary-item.total .summary-value {
      color: #fff;
    }

    .summary-label {
      font-size: 0.85rem;
      color: #64748b;
      font-weight: 500;
    }

    .summary-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .discount-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .discount-input input {
      width: 100px;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.95rem;
      height: 38px;
    }

    .currency {
      color: #64748b;
      font-size: 0.9rem;
    }

    .payment-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .payment-method,
    .sale-type {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .payment-method label,
    .sale-type label {
      font-weight: 500;
      color: #1e293b;
      font-size: 0.95rem;
    }

    .payment-method select,
    .sale-type select {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95rem;
      min-width: 140px;
      height: 42px;
      background: #fff;
    }

    .form-actions {
      display: flex;
      gap: 12px;
    }

    .form-actions button {
      padding: 10px 20px;
      font-size: 0.95rem;
      height: 42px;
      border-radius: 8px;
    }

    /* Dark Mode Styles */
    body.dark .new-sale-form {
      background: var(--dark-card);
    }

    body.dark .form-header {
      background: var(--dark-chart);
      border-color: #334155;
    }

    body.dark .info-row {
      background: var(--dark-card);
    }

    body.dark .product-input-section {
      background: var(--dark-chart);
    }

    body.dark .input-group input {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    body.dark .input-group input:focus {
      border-color: #3b82f6;
    }

    body.dark .invoice-table {
      background: var(--dark-card);
      border-color: #334155;
    }

    body.dark .invoice-table th {
      background: var(--dark-chart);
      color: var(--dark-text);
    }

    body.dark .invoice-table td {
      border-color: #334155;
      color: var(--dark-text);
    }

    body.dark .invoice-table tbody tr:hover {
      background: var(--dark-chart);
    }

    body.dark .invoice-summary {
      background: var(--dark-card);
      border-color: #334155;
    }

    body.dark .summary-item {
      background: var(--dark-chart);
    }

    body.dark .summary-label {
      color: #94a3b8;
    }

    body.dark .summary-value {
      color: var(--dark-text);
    }

    body.dark .discount-input input {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    body.dark .currency {
      color: #94a3b8;
    }

    body.dark .payment-section {
      background: var(--dark-chart);
    }

    body.dark .payment-method label,
    body.dark .sale-type label {
      color: var(--dark-text);
    }

    body.dark .payment-method select,
    body.dark .sale-type select {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .btn-icon {
      background: none;
      border: none;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      color: #64748b;
    }

    .btn-icon:hover {
      background-color: #f1f5f9;
    }

    .view-btn:hover {
      color: #3b82f6;
    }

    .delete-btn:hover {
      color: #ef4444;
    }

    body.dark .btn-icon {
      color: #94a3b8;
    }

    body.dark .btn-icon:hover {
      background-color: #1e293b;
    }

    body.dark .view-btn:hover {
      color: #60a5fa;
    }

    body.dark .delete-btn:hover {
      color: #f87171;
    }

    .bill-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 10px;
    }

    .detail-group {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .detail-group h4 {
      margin: 0 0 15px 0;
      color: #1e3a8a;
      font-size: 1.1rem;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      padding: 8px 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 4px 8px;
      background: #f8fafc;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
      font-size: 0.75rem;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
      font-size: 0.85rem;
    }

    /* الوضع الليلي */
    body.dark .detail-group {
      background: #0f172a;
    }

    body.dark .detail-group h4 {
      color: #f8fafc;
      border-bottom-color: #334155;
    }

    body.dark .detail-item {
      background: var(--dark-chart);
      border-color: #334155;
    }

    body.dark .detail-label {
      color: #94a3b8;
    }

    body.dark .detail-value {
      color: var(--dark-text);
    }

    /* تنسيقات نافذة تفاصيل عملية البيع */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background-color: #fff;
      margin: 2% auto;
      width: 90%;
      max-width: 600px;
      border-radius: 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      border-radius: 6px 6px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.1rem;
      color: #64748b;
      cursor: pointer;
      padding: 4px;
      transition: all 0.2s;
    }

    .close-modal:hover {
      color: #ef4444;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 10px;
    }

    .sale-details-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .detail-group {
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .detail-group-header {
      padding: 8px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-group-header h4 {
      margin: 0;
      color: #1e293b;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 8px 12px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .products-table {
      margin-top: 4px;
      overflow-x: auto;
    }

    .products-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .products-table th,
    .products-table td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.85rem;
    }

    .products-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
      white-space: nowrap;
    }

    .products-table tbody tr:hover {
      background: #f8fafc;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 8px 12px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      background: #f8fafc;
      border-radius: 4px;
    }

    .summary-item.total {
      grid-column: 1 / -1;
      background: #1e40af;
      color: #fff;
      padding: 8px;
      margin-top: 4px;
    }

    .summary-item.total .summary-label,
    .summary-item.total .summary-value {
      color: #fff;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 10px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      border-radius: 0 0 6px 6px;
    }

    .modal-footer button {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .modal-footer button:hover {
      transform: translateY(-1px);
    }

    /* Dark Mode Styles */
    body.dark .modal-content {
      background: var(--dark-card);
    }

    body.dark .modal-header {
      background: var(--dark-chart);
      border-color: #334155;
    }

    body.dark .modal-header h3 {
      color: var(--dark-text);
    }

    body.dark .close-modal {
      color: #94a3b8;
    }

    body.dark .close-modal:hover {
      color: #f87171;
    }

    body.dark .detail-group {
      background: var(--dark-card);
    }

    body.dark .detail-group-header {
      background: var(--dark-chart);
      border-color: #334155;
    }

    body.dark .detail-group-header h4 {
      color: var(--dark-text);
    }

    body.dark .detail-label {
      color: #94a3b8;
    }

    body.dark .detail-value {
      color: var(--dark-text);
    }

    body.dark .products-table th {
      background: var(--dark-chart);
      color: var(--dark-text);
    }

    body.dark .products-table td {
      border-color: #334155;
      color: var(--dark-text);
    }

    body.dark .products-table tbody tr:hover {
      background: var(--dark-chart);
    }

    body.dark .summary-item {
      background: var(--dark-chart);
    }

    body.dark .summary-item.total {
      background: #1e40af;
    }

    body.dark .modal-footer {
      background: var(--dark-chart);
      border-color: #334155;
    }

    /* تنسيقات إضافية للفواتير الواردة */
    .bill-details-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .detail-group {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .detail-group-header {
      padding: 10px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-group-header h4 {
      margin: 0;
      color: #1e293b;
      font-size: 1rem;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 10px 15px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      background: #f8fafc;
      border-radius: 4px;
    }

    .detail-item.total {
      grid-column: 1 / -1;
      background: #1e40af;
      color: white;
    }

    .detail-item.total .detail-label,
    .detail-item.total .detail-value {
      color: white;
    }

    .detail-label {
      font-size: 0.85rem;
      color: #64748b;
      font-weight: 500;
    }

    .detail-value {
      font-size: 0.95rem;
      color: #1e293b;
      font-weight: 600;
    }

    /* Dark Mode Styles */
    body.dark .detail-group {
      background: var(--dark-card);
    }

    body.dark .detail-group-header {
      background: var(--dark-chart);
      border-color: #334155;
    }

    body.dark .detail-group-header h4 {
      color: var(--dark-text);
    }

    body.dark .detail-item {
      background: var(--dark-chart);
    }

    body.dark .detail-label {
      color: #94a3b8;
    }

    body.dark .detail-value {
      color: var(--dark-text);
    }

    body.dark .detail-item.total {
      background: #1e40af;
    }

    /* تنسيقات الجداول */
    .table-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }

    .filter-controls {
      display: flex;
      gap: 12px;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
      min-width: 150px;
      background: #fff;
    }

    .table-scroll {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .table-scroll table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-scroll thead {
      position: sticky;
      top: 0;
      background: #f8fafc;
      z-index: 1;
    }

    .table-scroll th {
      padding: 12px 16px;
      text-align: right;
      font-weight: 600;
      color: #1e293b;
      border-bottom: 2px solid #e2e8f0;
      white-space: nowrap;
    }

    .table-scroll td {
      padding: 12px 16px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-scroll tbody tr:hover {
      background: #f8fafc;
    }

    /* Dark Mode Styles */
    body.dark .search-input {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    body.dark .search-icon {
      color: #94a3b8;
    }

    body.dark .filter-select {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    body.dark .table-scroll {
      border-color: #334155;
    }

    body.dark .table-scroll::-webkit-scrollbar-track {
      background: #1e293b;
    }

    body.dark .table-scroll::-webkit-scrollbar-thumb {
      background: #475569;
    }

    body.dark .table-scroll::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    body.dark .table-scroll thead {
      background: var(--dark-chart);
    }

    body.dark .table-scroll th {
      color: var(--dark-text);
      border-color: #334155;
    }

    body.dark .table-scroll td {
      border-color: #334155;
      color: var(--dark-text);
    }

    body.dark .table-scroll tbody tr:hover {
      background: var(--dark-chart);
    }

    .table-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 8px 0;
    }

    .pagination-btn {
      background: none;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    /* Dark Mode Styles */
    body.dark .pagination-btn {
      border-color: #334155;
      color: var(--dark-text);
    }

    body.dark .pagination-btn:hover {
      background: var(--dark-chart);
      border-color: #475569;
    }

    /* Top Action Bar Styles */
    .top-action-bar {
      display: flex;
      flex-direction: row-reverse;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      background: #fff;
      border-radius: 16px;
      padding: 18px 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .action-group-left {
      display: flex;
      gap: 18px;
    }
    .action-group-right {
      display: flex;
      gap: 18px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      padding: 12px 28px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .btn-blue {
      background: #2563eb;
      color: #fff;
    }
    .btn-blue:hover {
      background: #1d4ed8;
    }
    .btn-gray {
      background: #f1f5f9;
      color: #1e293b;
    }
    .btn-gray:hover {
      background: #e2e8f0;
    }
    .btn-green {
      background: #22c55e;
      color: #fff;
    }
    .btn-green:hover {
      background: #16a34a;
    }
    .action-btn i {
      font-size: 1.2em;
    }
    .action-btn.active, .action-btn.btn-blue.active {
      background: #2563eb !important;
      color: #fff !important;
    }
    @media (max-width: 700px) {
      .top-action-bar {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      .action-group-left, .action-group-right {
        width: 100%;
        justify-content: center;
      }
      .action-btn {
        width: 100%;
        justify-content: center;
      }
    }
    .filter-row {
      background: #f1f5f9;
    }
    .table-filter-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.95rem;
      margin: 0;
      box-sizing: border-box;
    }
    .filter-row select.table-filter-input {
      min-width: 80px;
    }
    .filter-row input[type="date"].table-filter-input {
      min-width: 120px;
    }
    .filter-row th {
      padding: 6px 8px;
    }

    .edit-column {
      width: 100px;
      text-align: center;
    }

    .quantity-edit {
      width: 60px;
      padding: 4px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      text-align: center;
    }

    body.dark .quantity-edit {
      background: var(--dark-card);
      color: var(--dark-text);
      border-color: #334155;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
      padding: 8px;
      background: #f8fafc;
      border-radius: 8px;
    }

    body.dark .edit-actions {
      background: var(--dark-chart);
    }
  </style>

    <!-- Add JavaScript functionality for the bills section -->
    <script>
      // تعريف بيانات المنتجات التجريبية
      const productsData = [
        { id: "123456", name: "قميص رجالي", price: 150, stock: 20 },
        { id: "234567", name: "بنطلون جينز", price: 200, stock: 15 },
        { id: "345678", name: "حذاء رياضي", price: 300, stock: 10 },
        { id: "456789", name: "ساعة يد", price: 500, stock: 8 },
        { id: "567890", name: "حقيبة ظهر", price: 180, stock: 12 },
        { id: "678901", name: "جاكيت شتوي", price: 400, stock: 7 },
        { id: "789012", name: "نظارة شمسية", price: 250, stock: 9 },
        { id: "890123", name: "محفظة جلدية", price: 120, stock: 15 },
        { id: "901234", name: "حزام رجالي", price: 80, stock: 20 },
        { id: "012345", name: "قبعة صيفية", price: 60, stock: 25 },
      ];

      // تعريف بيانات الفواتير الواردة التجريبية
      const incomingBillsData = [
        {
          id: "INV-001",
          storeName: "محل الأزياء الراقية",
          storeOwner: "أحمد محمد",
          electricity: { current: 500, overdue: 0, total: 500 },
          water: { current: 200, overdue: 0, total: 200 },
          rent: { current: 5000, overdue: 0, total: 5000 },
          month: "مارس 2024",
          total: 5700,
          status: "معلقة",
        },
        {
          id: "INV-002",
          storeName: "محل الإلكترونيات",
          storeOwner: "محمد علي",
          electricity: { current: 450, overdue: 500, total: 950 },
          water: { current: 180, overdue: 200, total: 380 },
          rent: { current: 5000, overdue: 5000, total: 10000 },
          month: "فبراير 2024",
          total: 11330,
          status: "متأخرة",
        },
        {
          id: "INV-003",
          storeName: "محل الأثاث المنزلي",
          storeOwner: "سارة أحمد",
          electricity: { current: 600, overdue: 0, total: 600 },
          water: { current: 250, overdue: 0, total: 250 },
          rent: { current: 6000, overdue: 0, total: 6000 },
          month: "مارس 2024",
          total: 6850,
          status: "مدفوعة",
        },
        {
          id: "INV-004",
          storeName: "محل الألعاب",
          storeOwner: "خالد عبدالله",
          electricity: { current: 350, overdue: 350, total: 700 },
          water: { current: 150, overdue: 150, total: 300 },
          rent: { current: 4500, overdue: 4500, total: 9000 },
          month: "يناير 2024",
          total: 10000,
          status: "متأخرة",
        },
        {
          id: "INV-005",
          storeName: "محل الحلويات",
          storeOwner: "نورة السعيد",
          electricity: { current: 550, overdue: 0, total: 550 },
          water: { current: 220, overdue: 0, total: 220 },
          rent: { current: 5500, overdue: 0, total: 5500 },
          month: "مارس 2024",
          total: 6270,
          status: "معلقة",
        },
        {
          id: "INV-006",
          storeName: "محل العطور",
          storeOwner: "عمر محمد",
          electricity: { current: 400, overdue: 0, total: 400 },
          water: { current: 180, overdue: 0, total: 180 },
          rent: { current: 4800, overdue: 0, total: 4800 },
          month: "مارس 2024",
          total: 5380,
          status: "مدفوعة",
        },
        {
          id: "INV-007",
          storeName: "محل الساعات",
          storeOwner: "فاطمة علي",
          electricity: { current: 300, overdue: 300, total: 600 },
          water: { current: 120, overdue: 120, total: 240 },
          rent: { current: 4000, overdue: 4000, total: 8000 },
          month: "فبراير 2024",
          total: 8840,
          status: "متأخرة",
        },
        {
          id: "INV-008",
          storeName: "محل النظارات",
          storeOwner: "عبدالله خالد",
          electricity: { current: 350, overdue: 0, total: 350 },
          water: { current: 150, overdue: 0, total: 150 },
          rent: { current: 4500, overdue: 0, total: 4500 },
          month: "مارس 2024",
          total: 5000,
          status: "معلقة",
        },
        {
          id: "INV-009",
          storeName: "محل الأحذية",
          storeOwner: "ريم السعيد",
          electricity: { current: 450, overdue: 0, total: 450 },
          water: { current: 200, overdue: 0, total: 200 },
          rent: { current: 5000, overdue: 0, total: 5000 },
          month: "مارس 2024",
          total: 5650,
          status: "مدفوعة",
        },
        {
          id: "INV-010",
          storeName: "محل الأجهزة المنزلية",
          storeOwner: "ياسر محمد",
          electricity: { current: 700, overdue: 700, total: 1400 },
          water: { current: 250, overdue: 250, total: 500 },
          rent: { current: 6000, overdue: 6000, total: 12000 },
          month: "يناير 2024",
          total: 13900,
          status: "متأخرة",
        },
      ];

    // تعريف بيانات المبيعات التجريبية
    const sampleSalesData = [
      {
        id: '#12345',
        date: '2024-03-15 14:30',
        employee: 'أحمد محمد',
        products: [
          { name: 'قميص رجالي', barcode: '123456', price: 150, quantity: 2, total: 300 },
          { name: 'بنطلون جينز', barcode: '234567', price: 200, quantity: 1, total: 200 }
        ],
        type: 'بيع',
        paymentMethod: 'نقدي',
        subtotal: 500,
        discount: 0,
        tax: 75,
        total: 575
      },
      {
        id: '#12346',
        date: '2024-03-15 15:45',
        employee: 'محمد علي',
        products: [
          { name: 'حذاء رياضي', barcode: '345678', price: 300, quantity: 1, total: 300 },
          { name: 'نظارة شمسية', barcode: '789012', price: 250, quantity: 1, total: 250 }
        ],
        type: 'حجز',
        paymentMethod: 'بطاقة',
        subtotal: 550,
        discount: 50,
        tax: 75,
        total: 575
      },
      {
        id: '#12347',
        date: '2024-03-15 16:20',
        employee: 'سارة أحمد',
        products: [
          { name: 'ساعة يد', barcode: '456789', price: 500, quantity: 1, total: 500 },
          { name: 'حقيبة ظهر', barcode: '567890', price: 180, quantity: 1, total: 180 }
        ],
        type: 'بيع',
        paymentMethod: 'تحويل',
        subtotal: 680,
        discount: 0,
        tax: 102,
        total: 782
      },
      {
        id: '#12348',
        date: '2024-03-16 10:15',
        employee: 'خالد عبدالله',
        products: [
          { name: 'جاكيت شتوي', barcode: '678901', price: 400, quantity: 1, total: 400 },
          { name: 'قبعة صيفية', barcode: '012345', price: 60, quantity: 2, total: 120 }
        ],
        type: 'بيع',
        paymentMethod: 'نقدي',
        subtotal: 520,
        discount: 20,
        tax: 75,
        total: 575
      },
      {
        id: '#12349',
        date: '2024-03-16 11:30',
        employee: 'نورة السعيد',
        products: [
          { name: 'محفظة جلدية', barcode: '890123', price: 120, quantity: 1, total: 120 },
          { name: 'حزام رجالي', barcode: '901234', price: 80, quantity: 1, total: 80 }
        ],
        type: 'حجز',
        paymentMethod: 'بطاقة',
        subtotal: 200,
        discount: 0,
        tax: 30,
        total: 230
      },
      {
        id: '#12350',
        date: '2024-03-16 13:45',
        employee: 'عمر محمد',
        products: [
          { name: 'قميص رجالي', barcode: '123456', price: 150, quantity: 3, total: 450 },
          { name: 'بنطلون جينز', barcode: '234567', price: 200, quantity: 2, total: 400 }
        ],
        type: 'بيع',
        paymentMethod: 'تحويل',
        subtotal: 850,
        discount: 50,
        tax: 120,
        total: 920
      },
      {
        id: '#12351',
        date: '2024-03-17 09:20',
        employee: 'فاطمة أحمد',
        products: [
          { name: 'حذاء رياضي', barcode: '345678', price: 300, quantity: 2, total: 600 },
          { name: 'نظارة شمسية', barcode: '789012', price: 250, quantity: 1, total: 250 }
        ],
        type: 'بيع',
        paymentMethod: 'نقدي',
        subtotal: 850,
        discount: 0,
        tax: 127.5,
        total: 977.5
      },
      {
        id: '#12352',
        date: '2024-03-17 10:35',
        employee: 'عبدالله خالد',
        products: [
          { name: 'ساعة يد', barcode: '456789', price: 500, quantity: 1, total: 500 },
          { name: 'حقيبة ظهر', barcode: '567890', price: 180, quantity: 2, total: 360 }
        ],
        type: 'حجز',
        paymentMethod: 'بطاقة',
        subtotal: 860,
        discount: 60,
        tax: 120,
        total: 920
      },
      {
        id: '#12353',
        date: '2024-03-17 12:50',
        employee: 'سارة محمد',
        products: [
          { name: 'جاكيت شتوي', barcode: '678901', price: 400, quantity: 1, total: 400 },
          { name: 'قبعة صيفية', barcode: '012345', price: 60, quantity: 3, total: 180 }
        ],
        type: 'بيع',
        paymentMethod: 'تحويل',
        subtotal: 580,
        discount: 30,
        tax: 82.5,
        total: 632.5
      },
      {
        id: '#12354',
        date: '2024-03-17 14:15',
        employee: 'محمد علي',
        products: [
          { name: 'محفظة جلدية', barcode: '890123', price: 120, quantity: 2, total: 240 },
          { name: 'حزام رجالي', barcode: '901234', price: 80, quantity: 2, total: 160 }
        ],
        type: 'بيع',
        paymentMethod: 'نقدي',
        subtotal: 400,
        discount: 0,
        tax: 60,
        total: 460
      }
    ];

    // تعريف بيانات الفواتير الواردة التجريبية
    const sampleBillsData = [
      {
        id: 'INV-001',
        storeName: 'محل الأزياء الراقية',
        storeOwner: 'أحمد محمد',
        electricity: {
          current: 500,
          overdue: 0,
          total: 500
        },
        water: {
          current: 200,
          overdue: 0,
          total: 200
        },
        rent: {
          current: 5000,
          overdue: 0,
          total: 5000
        },
        month: 'مارس 2024',
        total: 5700,
        status: 'معلقة'
      },
      {
        id: 'INV-002',
        storeName: 'محل الإلكترونيات',
        storeOwner: 'محمد علي',
        electricity: {
          current: 450,
          overdue: 500,
          total: 950
        },
        water: {
          current: 180,
          overdue: 200,
          total: 380
        },
        rent: {
          current: 5000,
          overdue: 5000,
          total: 10000
        },
        month: 'فبراير 2024',
        total: 11330,
        status: 'متأخرة'
      },
      {
        id: 'INV-003',
        storeName: 'محل الأثاث',
        storeOwner: 'سارة أحمد',
        electricity: {
          current: 600,
          overdue: 0,
          total: 600
        },
        water: {
          current: 250,
          overdue: 0,
          total: 250
        },
        rent: {
          current: 6000,
          overdue: 0,
          total: 6000
        },
        month: 'مارس 2024',
        total: 6850,
        status: 'مدفوعة'
      },
      {
        id: 'INV-004',
        storeName: 'محل الألعاب',
        storeOwner: 'خالد عبدالله',
        electricity: {
          current: 400,
          overdue: 400,
          total: 800
        },
        water: {
          current: 150,
          overdue: 150,
          total: 300
        },
        rent: {
          current: 4500,
          overdue: 4500,
          total: 9000
        },
        month: 'يناير 2024',
        total: 10100,
        status: 'متأخرة'
      },
      {
        id: 'INV-005',
        storeName: 'محل الحلويات',
        storeOwner: 'نورة السعيد',
        electricity: {
          current: 550,
          overdue: 0,
          total: 550
        },
        water: {
          current: 220,
          overdue: 0,
          total: 220
        },
        rent: {
          current: 5500,
          overdue: 0,
          total: 5500
        },
        month: 'مارس 2024',
        total: 6270,
        status: 'معلقة'
      },
      {
        id: 'INV-006',
        storeName: 'محل العطور',
        storeOwner: 'عمر محمد',
        electricity: {
          current: 350,
          overdue: 350,
          total: 700
        },
        water: {
          current: 120,
          overdue: 120,
          total: 240
        },
        rent: {
          current: 4800,
          overdue: 4800,
          total: 9600
        },
        month: 'فبراير 2024',
        total: 10540,
        status: 'متأخرة'
      },
      {
        id: 'INV-007',
        storeName: 'محل الساعات',
        storeOwner: 'فاطمة أحمد',
        electricity: {
          current: 480,
          overdue: 0,
          total: 480
        },
        water: {
          current: 180,
          overdue: 0,
          total: 180
        },
        rent: {
          current: 5200,
          overdue: 0,
          total: 5200
        },
        month: 'مارس 2024',
        total: 5860,
        status: 'مدفوعة'
      },
      {
        id: 'INV-008',
        storeName: 'محل النظارات',
        storeOwner: 'عبدالله خالد',
        electricity: {
          current: 420,
          overdue: 420,
          total: 840
        },
        water: {
          current: 160,
          overdue: 160,
          total: 320
        },
        rent: {
          current: 4700,
          overdue: 4700,
          total: 9400
        },
        month: 'يناير 2024',
        total: 10560,
        status: 'متأخرة'
      },
      {
        id: 'INV-009',
        storeName: 'محل الأحذية',
        storeOwner: 'سارة محمد',
        electricity: {
          current: 520,
          overdue: 0,
          total: 520
        },
        water: {
          current: 200,
          overdue: 0,
          total: 200
        },
        rent: {
          current: 5300,
          overdue: 0,
          total: 5300
        },
        month: 'مارس 2024',
        total: 6020,
        status: 'معلقة'
      },
      {
        id: 'INV-010',
        storeName: 'محل الحقائب',
        storeOwner: 'محمد علي',
        electricity: {
          current: 380,
          overdue: 380,
          total: 760
        },
        water: {
          current: 140,
          overdue: 140,
          total: 280
        },
        rent: {
          current: 4600,
          overdue: 4600,
          total: 9200
        },
        month: 'فبراير 2024',
        total: 10240,
        status: 'متأخرة'
      }
    ];

    // تحميل بيانات المبيعات في الجدول
    function loadSalesData() {
      const tbody = document.getElementById('sales-table-body');
      const searchTerm = document.getElementById('sales-search').value.toLowerCase();
      const typeFilter = document.getElementById('sales-type-filter').value;
      const employeeFilter = document.getElementById('sales-employee-filter').value;
      const dateFilter = document.getElementById('sales-date-filter').value;
      
      let filteredData = sampleSalesData.filter(sale => {
        let match = true;
        if (searchTerm && !(
          sale.id.toLowerCase().includes(searchTerm) ||
          sale.employee.toLowerCase().includes(searchTerm) ||
          sale.type.toLowerCase().includes(searchTerm)
        )) match = false;
        if (typeFilter !== 'all' && sale.type !== typeFilter) match = false;
        if (employeeFilter !== 'all' && sale.employee !== employeeFilter) match = false;
        if (dateFilter && !sale.date.startsWith(dateFilter)) match = false;
        return match;
      });
      
      // عرض البيانات
      tbody.innerHTML = '';
      filteredData.forEach(sale => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sale.id}</td>
          <td>${sale.date}</td>
          <td>${sale.employee}</td>
          <td>${sale.products.length}</td>
          <td>${sale.type}</td>
          <td>${sale.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewSaleDetails('${sale.id}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printSale('${sale.id}')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
          tbody.appendChild(row);
        });
        console.log("Sales data loaded successfully");
      }

      // إضافة بيانات تجريبية للفواتير الواردة
      function loadIncomingBills() {
        console.log("Loading incoming bills...");
        const tbody = document.getElementById("incoming-bills-table-body");
        if (!tbody) {
          console.error("Incoming bills table body not found");
          return;
        }

        tbody.innerHTML = "";
        incomingBillsData.forEach((bill) => {
          const row = document.createElement("tr");
          row.setAttribute("data-status", bill.status);
          row.setAttribute("data-month", bill.month.split(" ")[0]);
          row.innerHTML = `
          <td>${bill.electricity.current} ريال</td>
          <td>${bill.water.current} ريال</td>
          <td>${bill.rent.current} ريال</td>
          <td>${bill.month}</td>
          <td>${
            bill.electricity.overdue + bill.water.overdue + bill.rent.overdue
          } ريال</td>
          <td>${bill.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewIncomingBillDetails('${
                bill.id
              }')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printIncomingBill('${
                bill.id
              }')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
          tbody.appendChild(row);
        });
        console.log("Incoming bills loaded successfully");
      }

      // البحث في المبيعات
      function searchSales(query) {
        const tbody = document.getElementById("sales-table-body");
        if (!tbody) return;

        const rows = tbody.getElementsByTagName("tr");
        query = query.toLowerCase();

        for (let row of rows) {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? "" : "none";
        }
      }

      // فلترة الفواتير حسب الحالة والشهر
      function filterBills() {
        const statusFilter =
          document.getElementById("bill-status-filter").value;
        const monthFilter = document.getElementById("bill-month-filter").value;
        const tbody = document.getElementById("incoming-bills-table-body");
        if (!tbody) return;

        const rows = tbody.getElementsByTagName("tr");

        for (let row of rows) {
          const status = row.getAttribute("data-status");
          const month = row.getAttribute("data-month");

          const statusMatch = statusFilter === "all" || status === statusFilter;
          const monthMatch = monthFilter === "all" || month === monthFilter;

          row.style.display = statusMatch && monthMatch ? "" : "none";
        }
      }

      // وظائف المبيعات
      function openNewSaleForm() {
        const form = document.getElementById("new-sale-form");
        if (!form) return;

        form.style.display = "block";

        // تحديث التاريخ والوقت
        const now = new Date();
        document.getElementById("sale-date").textContent =
          now.toLocaleString("ar-SA");

        // تحديث رقم العملية
        const saleNumber = Math.floor(Math.random() * 100000);
        document.getElementById("sale-number").textContent = `#${saleNumber}`;

        // تفعيل حقل الباركود
        document.getElementById("barcode-input").focus();

        // إعادة تعيين القيم
        resetSaleForm();
      }

      // البحث عن المنتج بالباركود
      function findProductByBarcode(barcode) {
        return productsData.find((product) => product.id === barcode);
      }

      // البحث عن المنتج بالاسم
      function findProductByName(name) {
        return productsData.find((product) => product.name === name);
      }

      // تحديث حقول المنتج
      function updateProductFields(product) {
        if (product) {
          document.getElementById("barcode-input").value = product.id;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-quantity").max = product.stock;
          document.getElementById("product-quantity").value = "1";
          document.getElementById("product-quantity").focus();
        }
      }

      // إضافة منتج للبيع
      function addProductToSale() {
        const barcode = document.getElementById("barcode-input").value.trim();
        const productName = document
          .getElementById("product-name")
          .value.trim();
        const quantity = parseInt(
          document.getElementById("product-quantity").value
        );

        if (!barcode || !productName || quantity < 1) {
          alert("يرجى إدخال جميع البيانات المطلوبة");
          return;
        }

        const product = findProductByBarcode(barcode);
        if (!product) {
          alert("المنتج غير موجود");
          return;
        }

        if (quantity > product.stock) {
          alert("الكمية المطلوبة غير متوفرة في المخزون");
          return;
        }

        const tbody = document.getElementById("selected-products-list");
        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${product.name}</td>
        <td>${product.id}</td>
        <td>${product.price} ريال</td>
        <td>${quantity}</td>
        <td>${product.price * quantity} ريال</td>
        <td>
          <button class="btn-icon delete-btn" onclick="removeProduct(this)" title="حذف المنتج">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      `;
        tbody.appendChild(row);

        // إعادة تعيين الحقول
        document.getElementById("barcode-input").value = "";
        document.getElementById("product-name").value = "";
        document.getElementById("product-quantity").value = "1";
        document.getElementById("barcode-input").focus();

        updateBillSummary();
      }

      // حذف منتج
      function removeProduct(button) {
        button.closest("tr").remove();
        updateBillSummary();
      }

      // تحديث ملخص الفاتورة
      function updateBillSummary() {
        const rows = document.querySelectorAll("#selected-products-list tr");
        let subtotal = 0;

        rows.forEach((row) => {
          const totalText = row.cells[4].textContent;
          const total = parseFloat(totalText.replace(" ريال", ""));
          subtotal += total;
        });

        const discount =
          parseFloat(document.getElementById("discount").value) || 0;
        const tax = parseFloat(document.getElementById("tax").value) || 0;
        const afterDiscount = subtotal - discount;
        const finalTotal = afterDiscount + tax;

        document.getElementById("products-count").textContent = rows.length;
        document.getElementById("subtotal").textContent = `${subtotal.toFixed(
          2
        )} ريال`;
        document.getElementById("total").textContent = `${finalTotal.toFixed(
          2
        )} ريال`;
      }

      // إتمام عملية البيع
      function completeSale() {
        try {
          const products = document.getElementById(
            "selected-products-list"
          ).children;
          if (!products || products.length === 0) {
            alert("يرجى إضافة منتج واحد على الأقل");
            return;
          }

          // جمع بيانات العملية
          const saleNumber = document.getElementById("sale-number").textContent;
          const saleDate = document.getElementById("sale-date").textContent;
          const saleType = document.getElementById("sale-type").value;
          const paymentMethod = document.getElementById("payment-method").value;
          const total = document.getElementById("total").textContent;
          const discount = document.getElementById("discount").value;
          const tax = document.getElementById("tax").value;

          // جمع بيانات المنتجات
          const saleProducts = [];
          Array.from(products).forEach((product) => {
            saleProducts.push({
              name: product.cells[0].textContent,
              barcode: product.cells[1].textContent,
              price: parseFloat(product.cells[2].textContent),
              quantity: parseInt(product.cells[3].textContent),
              total: parseFloat(product.cells[4].textContent),
            });
          });

          // إنشاء كائن بيانات العملية
          const saleData = {
            id: saleNumber,
            date: saleDate,
            type: saleType,
            paymentMethod: paymentMethod,
            products: saleProducts,
            subtotal: parseFloat(
              document.getElementById("subtotal").textContent
            ),
            discount: parseFloat(discount),
            tax: parseFloat(tax),
            total: parseFloat(total.replace(" ريال", "")),
            employee: getCurrentEmployee(),
          };

          // إضافة العملية إلى مصفوفة التاريخ
          salesHistory.push(saleData);

          // إضافة العملية إلى جدول المبيعات
          const tbody = document.getElementById("sales-table-body");
          if (!tbody) {
            throw new Error("لم يتم العثور على جدول المبيعات");
          }

          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${saleData.id}</td>
          <td>${saleData.date}</td>
          <td>${saleData.employee}</td>
          <td>${saleData.products.length}</td>
          <td>${saleData.type}</td>
          <td>${saleData.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewSaleDetails('${saleData.id}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printSale('${saleData.id}')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
          tbody.appendChild(row);

          // عرض رسالة نجاح
          alert("تم إتمام عملية البيع بنجاح");

          // إغلاق النموذج وإعادة تعيينه
          closeNewSaleForm();
        } catch (error) {
          console.error("حدث خطأ أثناء إتمام عملية البيع:", error);
          alert("حدث خطأ أثناء إتمام عملية البيع. يرجى المحاولة مرة أخرى.");
        }
      }

    // الحصول على بيانات العملية
    function getSaleData(saleId) {
      return sampleSalesData.find(sale => sale.id === saleId);
    }

      // عرض تفاصيل عملية البيع
      function viewSaleDetails(saleId) {
        const saleData = getSaleData(saleId);
        if (!saleData) return;

        // تحديث معلومات العملية
        document.getElementById("sale-detail-id").textContent = saleData.id;
        document.getElementById("sale-detail-date").textContent = saleData.date;
        document.getElementById("sale-detail-employee").textContent =
          saleData.employee;
        document.getElementById("sale-detail-type").textContent = saleData.type;
        document.getElementById("sale-detail-payment").textContent =
          saleData.paymentMethod;

        // تحديث جدول المنتجات
        const productsTable = document.getElementById("sale-detail-products");
        productsTable.innerHTML = "";
        saleData.products.forEach((product) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.barcode}</td>
          <td>${product.price} ريال</td>
          <td>${product.quantity}</td>
          <td>${product.total} ريال</td>
        `;
          productsTable.appendChild(row);
        });

        // تحديث ملخص الفاتورة
        document.getElementById("sale-detail-products-count").textContent =
          saleData.products.length;
        document.getElementById(
          "sale-detail-subtotal"
        ).textContent = `${saleData.subtotal} ريال`;
        document.getElementById(
          "sale-detail-discount"
        ).textContent = `${saleData.discount} ريال`;
        document.getElementById(
          "sale-detail-tax"
        ).textContent = `${saleData.tax} ريال`;
        document.getElementById(
          "sale-detail-total"
        ).textContent = `${saleData.total} ريال`;

        // عرض النافذة المنبثقة
        const modal = document.getElementById("saleDetailsModal");
        modal.style.display = "block";
      }

      // إغلاق نافذة تفاصيل العملية
      function closeSaleDetailsModal() {
        const modal = document.getElementById("saleDetailsModal");
        modal.style.display = "none";
      }

      // طباعة الفاتورة
      function printSale(saleId) {
        const saleData = getSaleData(saleId);
        if (saleData) {
          const invoiceContent = `
          <div class="invoice-print">
            <div class="invoice-header">
              <div class="store-info">
                <h1>اسم المتجر</h1>
                <p>العنوان: شارع الرئيسي، المدينة</p>
                <p>هاتف: 0123456789</p>
                <p>البريد الإلكتروني: store@example.com</p>
              </div>
              <div class="invoice-info">
                <h2>فاتورة بيع</h2>
                <div class="info-grid">
                  <div class="info-item">
                    <span class="label">رقم العملية:</span>
                    <span class="value">${saleData.id}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">التاريخ:</span>
                    <span class="value">${saleData.date}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">الموظف:</span>
                    <span class="value">${saleData.employee}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">نوع العملية:</span>
                    <span class="value">${saleData.type}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">طريقة الدفع:</span>
                    <span class="value">${saleData.paymentMethod}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="invoice-body">
              <table class="products-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>المنتج</th>
                    <th>الباركود</th>
                    <th>السعر</th>
                    <th>الكمية</th>
                    <th>الإجمالي</th>
                  </tr>
                </thead>
                <tbody>
                  ${saleData.products
                    .map(
                      (product, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${product.name}</td>
                      <td>${product.barcode}</td>
                      <td>${product.price} ريال</td>
                      <td>${product.quantity}</td>
                      <td>${product.total} ريال</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>

            <div class="invoice-summary">
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="label">عدد المنتجات:</span>
                  <span class="value">${saleData.products.length}</span>
                </div>
                <div class="summary-item">
                  <span class="label">إجمالي المنتجات:</span>
                  <span class="value">${saleData.subtotal} ريال</span>
                </div>
                <div class="summary-item">
                  <span class="label">الخصم:</span>
                  <span class="value">${saleData.discount} ريال</span>
                </div>
                <div class="summary-item">
                  <span class="label">الضريبة:</span>
                  <span class="value">${saleData.tax} ريال</span>
                </div>
                <div class="summary-item total">
                  <span class="label">الإجمالي النهائي:</span>
                  <span class="value">${saleData.total} ريال</span>
                </div>
              </div>
            </div>

            <div class="invoice-footer">
              <p>شكراً لتعاملكم معنا</p>
              <p>نتمنى لكم تجربة تسوق ممتعة</p>
            </div>
          </div>
        `;

          const printWindow = window.open("", "_blank");
          printWindow.document.write(`
          <html dir="rtl">
            <head>
              <title>فاتورة بيع - ${saleData.id}</title>
              <style>
                @media print {
                  body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                    color: #333;
                  }

                  .invoice-print {
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                  }

                  .invoice-header {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #eee;
                  }

                  .store-info {
                    text-align: right;
                  }

                  .store-info h1 {
                    margin: 0 0 10px 0;
                    color: #1e40af;
                    font-size: 24px;
                  }

                  .store-info p {
                    margin: 5px 0;
                    color: #666;
                    font-size: 14px;
                  }

                  .invoice-info {
                    text-align: left;
                  }

                  .invoice-info h2 {
                    margin: 0 0 15px 0;
                    color: #1e40af;
                    font-size: 20px;
                  }

                  .info-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                  }

                  .info-item {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                  }

                  .info-item .label {
                    font-size: 12px;
                    color: #666;
                  }

                  .info-item .value {
                    font-size: 14px;
                    font-weight: bold;
                    color: #333;
                  }

                  .products-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                  }

                  .products-table th,
                  .products-table td {
                    padding: 10px;
                    text-align: right;
                    border: 1px solid #ddd;
                    font-size: 14px;
                  }

                  .products-table th {
                    background-color: #f8fafc;
                    font-weight: bold;
                    color: #1e40af;
                  }

                  .products-table tr:nth-child(even) {
                    background-color: #f8fafc;
                  }

                  .invoice-summary {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f8fafc;
                    border-radius: 8px;
                  }

                  .summary-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                  }

                  .summary-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                  }

                  .summary-item.total {
                    grid-column: 1 / -1;
                    background-color: #1e40af;
                    color: white;
                    border-radius: 4px;
                    margin-top: 10px;
                    padding: 12px;
                  }

                  .summary-item.total .label,
                  .summary-item.total .value {
                    color: white;
                    font-weight: bold;
                  }

                  .invoice-footer {
                    margin-top: 30px;
                    text-align: center;
                    padding-top: 20px;
                    border-top: 2px solid #eee;
                  }

                  .invoice-footer p {
                    margin: 5px 0;
                    color: #666;
                    font-size: 14px;
                  }

                  @page {
                    size: A4;
                    margin: 0;
                }
              </style>
            </head>
            <body>
              ${invoiceContent}
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }
    }

      // إغلاق نموذج البيع
      function closeNewSaleForm() {
        const form = document.getElementById("new-sale-form");
        const hasProducts =
          document.getElementById("selected-products-list").children.length > 0;

        if (hasProducts) {
          if (
            confirm(
              "هل أنت متأكد من إلغاء عملية البيع؟ سيتم فقدان جميع المنتجات المضافة."
            )
          ) {
            form.style.display = "none";
            resetSaleForm();
          }
        } else {
          form.style.display = "none";
          resetSaleForm();
        }
      }

      // إعادة تعيين نموذج البيع
      function resetSaleForm() {
        document.getElementById("selected-products-list").innerHTML = "";
        document.getElementById("barcode-input").value = "";
        document.getElementById("product-name").value = "";
        document.getElementById("product-quantity").value = "1";
        document.getElementById("discount").value = "0";
        document.getElementById("tax").value = "0";
        document.getElementById("products-count").textContent = "0";
        document.getElementById("subtotal").textContent = "0.00 ريال";
        document.getElementById("total").textContent = "0.00 ريال";
        document.getElementById("payment-method").value = "نقدي";
        document.getElementById("sale-type").value = "بيع";
      }

      // الحصول على اسم الموظف الحالي
      function getCurrentEmployee() {
        // هنا يمكن إضافة كود للحصول على اسم الموظف من نظام تسجيل الدخول
        return "اسم الموظف";
      }

      // ملء قائمة المنتجات
      function fillProductsList() {
        const datalist = document.getElementById("products-list");
        if (!datalist) return;
        datalist.innerHTML = "";
        productsData.forEach((product) => {
          const option = document.createElement("option");
          option.value = product.name;
          datalist.appendChild(option);
        });
      }

      // التحقق من صحة المنتج
      function validateProductInput() {
        const input = document.getElementById("product-name");
        const error = document.getElementById("product-error");
        if (!input || !error) return;

        if (
          input.value &&
          !productsData.some((product) => product.name === input.value)
        ) {
          error.style.display = "block";
          input.setCustomValidity("المنتج غير موجود في القائمة");
        } else {
          error.style.display = "none";
          input.setCustomValidity("");
        }
      }

      // إضافة مستمعي الأحداث
      document.addEventListener("DOMContentLoaded", function () {
        // إضافة مستمع للبحث في المبيعات
        const salesSearch = document.getElementById("sales-search");
        if (salesSearch) {
          salesSearch.addEventListener("input", function (e) {
            searchSales(e.target.value);
          });
        }

        // إضافة مستمعي الفلترة للفواتير
        const statusFilter = document.getElementById("bill-status-filter");
        const monthFilter = document.getElementById("bill-month-filter");
        if (statusFilter) {
          statusFilter.addEventListener("change", filterBills);
        }
        if (monthFilter) {
          monthFilter.addEventListener("change", filterBills);
        }

        // معالجة مسح الباركود
        const barcodeInput = document.getElementById("barcode-input");
        if (barcodeInput) {
          barcodeInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              const barcode = this.value.trim();
              if (barcode) {
                const product = findProductByBarcode(barcode);
                if (product) {
                  updateProductFields(product);
                } else {
                  alert("المنتج غير موجود");
                  this.value = "";
                }
              }
            }
          });
        }

        // معالجة تغيير اسم المنتج
        const productNameInput = document.getElementById("product-name");
        if (productNameInput) {
          productNameInput.addEventListener("change", function () {
            const productName = this.value.trim();
            if (productName) {
              const product = findProductByName(productName);
              if (product) {
                updateProductFields(product);
              }
            }
          });
        }

        // إغلاق النافذة المنبثقة عند النقر خارجها
        window.onclick = function (event) {
          const modal = document.getElementById("saleDetailsModal");
          if (event.target === modal) {
            closeSaleDetailsModal();
          }
        };
      });

      // عرض تفاصيل الفاتورة الواردة
      function viewIncomingBillDetails(billId) {
        const bill = incomingBillsData.find((b) => b.id === billId);
        if (!bill) return;

        // تحديث معلومات المحل
        document.getElementById("store-name").textContent = bill.storeName;
        document.getElementById("store-owner").textContent = bill.storeOwner;

        // تحديث فاتورة الكهرباء
        document.getElementById(
          "current-electricity"
        ).textContent = `${bill.electricity.current} ريال`;
        document.getElementById(
          "overdue-electricity"
        ).textContent = `${bill.electricity.overdue} ريال`;
        document.getElementById(
          "total-electricity"
        ).textContent = `${bill.electricity.total} ريال`;

        // تحديث فاتورة الماء
        document.getElementById(
          "current-water"
        ).textContent = `${bill.water.current} ريال`;
        document.getElementById(
          "overdue-water"
        ).textContent = `${bill.water.overdue} ريال`;
        document.getElementById(
          "total-water"
        ).textContent = `${bill.water.total} ريال`;

        // تحديث الإيجار
        document.getElementById(
          "current-rent"
        ).textContent = `${bill.rent.current} ريال`;
        document.getElementById(
          "overdue-rent"
        ).textContent = `${bill.rent.overdue} ريال`;
        document.getElementById(
          "total-rent"
        ).textContent = `${bill.rent.total} ريال`;

        // تحديث الإجمالي الكلي
        document.getElementById(
          "total-bill"
        ).textContent = `${bill.total} ريال`;

        // عرض النافذة المنبثقة
        const modal = document.getElementById("incomingBillDetailsModal");
        modal.style.display = "block";
      }

      // إغلاق نافذة تفاصيل الفاتورة الواردة
      function closeIncomingBillDetailsModal() {
        const modal = document.getElementById("incomingBillDetailsModal");
        modal.style.display = "none";
      }

      // حذف الفاتورة الواردة
      function deleteIncomingBill(billId) {
        if (confirm("هل أنت متأكد من حذف هذه الفاتورة؟")) {
          const index = incomingBillsData.findIndex((b) => b.id === billId);
          if (index !== -1) {
            incomingBillsData.splice(index, 1);
            loadIncomingBills();
          }
        }
      }

      // طباعة الفاتورة الواردة
      function printIncomingBill(billId) {
        const bill = incomingBillsData.find((b) => b.id === billId);
        if (!bill) return;

        const printContent = `
        <div class="invoice-print">
          <div class="invoice-header">
            <div class="store-info">
              <h1>${bill.storeName}</h1>
              <p>صاحب المحل: ${bill.storeOwner}</p>
              <p>الشهر: ${bill.month}</p>
            </div>
          </div>

          <div class="invoice-body">
            <div class="bill-section">
              <h3>فاتورة الكهرباء</h3>
              <div class="bill-details">
                <p>مبلغ الشهر الحالي: ${bill.electricity.current} ريال</p>
                <p>المتأخرات: ${bill.electricity.overdue} ريال</p>
                <p class="total">الإجمالي: ${bill.electricity.total} ريال</p>
              </div>
            </div>

            <div class="bill-section">
              <h3>فاتورة الماء</h3>
              <div class="bill-details">
                <p>مبلغ الشهر الحالي: ${bill.water.current} ريال</p>
                <p>المتأخرات: ${bill.water.overdue} ريال</p>
                <p class="total">الإجمالي: ${bill.water.total} ريال</p>
              </div>
            </div>

            <div class="bill-section">
              <h3>الإيجار</h3>
              <div class="bill-details">
                <p>مبلغ الشهر الحالي: ${bill.rent.current} ريال</p>
                <p>المتأخرات: ${bill.rent.overdue} ريال</p>
                <p class="total">الإجمالي: ${bill.rent.total} ريال</p>
              </div>
            </div>

            <div class="bill-total">
              <h3>إجمالي الفاتورة</h3>
              <p class="total">${bill.total} ريال</p>
            </div>
          </div>
        </div>
      `;

        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
        <html dir="rtl">
          <head>
            <title>فاتورة - ${bill.id}</title>
            <style>
              @media print {
                body {
                  font-family: Arial, sans-serif;
                  margin: 0;
                  padding: 20px;
                  color: #333;
                }

                .invoice-print {
                  max-width: 800px;
                  margin: 0 auto;
                }

                .invoice-header {
                  text-align: center;
                  margin-bottom: 30px;
                  padding-bottom: 20px;
                  border-bottom: 2px solid #eee;
                }

                .store-info h1 {
                  margin: 0 0 10px 0;
                  color: #1e40af;
                  font-size: 24px;
                }

                .store-info p {
                  margin: 5px 0;
                  color: #666;
                  font-size: 14px;
                }

                .bill-section {
                  margin-bottom: 20px;
                  padding: 15px;
                  background: #f8fafc;
                  border-radius: 8px;
                }

                .bill-section h3 {
                  margin: 0 0 10px 0;
                  color: #1e40af;
                  font-size: 18px;
                }

                .bill-details p {
                  margin: 5px 0;
                  font-size: 14px;
                }

                .bill-details .total {
                  font-weight: bold;
                  color: #1e40af;
                  margin-top: 10px;
                  padding-top: 10px;
                  border-top: 1px solid #eee;
                }

                .bill-total {
                  margin-top: 30px;
                  padding: 20px;
                  background: #1e40af;
                  color: white;
                  border-radius: 8px;
                  text-align: center;
                }

                .bill-total h3 {
                  margin: 0 0 10px 0;
                  font-size: 20px;
                }

                .bill-total .total {
                  font-size: 24px;
                  font-weight: bold;
                }

                @page {
                  size: A4;
                  margin: 0;
                }
              </style>
            </head>
            <body>
              ${printContent}
            </body>
          </html>
        `);
      printWindow.document.close();
      printWindow.print();
    }

    // متغيرات الصفحات
    let currentSalesPage = 1;
    let currentBillsPage = 1;
    const itemsPerPage = 5;

    // وظائف التنقل بين الصفحات
    function nextSalesPage() {
      const totalPages = Math.ceil(sampleSalesData.length / itemsPerPage);
      if (currentSalesPage < totalPages) {
        currentSalesPage++;
        loadSalesData();
      }
    }

    function previousSalesPage() {
      if (currentSalesPage > 1) {
        currentSalesPage--;
        loadSalesData();
      }
    }

    function nextBillsPage() {
      const totalPages = Math.ceil(sampleBillsData.length / itemsPerPage);
      if (currentBillsPage < totalPages) {
        currentBillsPage++;
        loadBillsData();
      }
    }

    function previousBillsPage() {
      if (currentBillsPage > 1) {
        currentBillsPage--;
        loadBillsData();
      }
    }

    // إضافة مستمعي الأحداث
    document.addEventListener('DOMContentLoaded', function() {
      // تحميل البيانات الأولية
      loadSalesData();
      loadBillsData();
      
      // إضافة مستمع للبحث
      document.getElementById('sales-search').addEventListener('input', function() {
        loadSalesData();
      });
      
      // إضافة مستمعين للفلترة
      document.getElementById('month-filter').addEventListener('change', function() {
        loadBillsData();
      });
      
      document.getElementById('bill-status-filter').addEventListener('change', function() {
        loadBillsData();
      });
      
      // إضافة مستمع للفلتر الجديد
      document.getElementById('bills-total-payment-filter').addEventListener('change', function() {
        loadBillsData();
      });
    });

    // تحميل بيانات الفواتير الواردة
    function loadBillsData() {
      const tbody = document.getElementById('incoming-bills-table-body');
      const monthFilter = document.getElementById('bills-month-filter').value;
      const overdueFilter = document.getElementById('bills-overdue-filter').value;
      const totalPaymentFilter = document.getElementById('bills-total-payment-filter').value;
      
      let filteredData = sampleBillsData;
      if (monthFilter !== 'all') {
        filteredData = filteredData.filter(bill => bill.month.toLowerCase().includes(monthFilter));
      }
      if (overdueFilter === 'no') {
        filteredData = filteredData.filter(bill => (bill.electricity.overdue + bill.water.overdue + bill.rent.overdue) === 0);
      } else if (overdueFilter === 'yes') {
        filteredData = filteredData.filter(bill => (bill.electricity.overdue + bill.water.overdue + bill.rent.overdue) > 0);
      }
      
      // تطبيق فلتر الإجمالي المدفوع/غير المدفوع
      if (totalPaymentFilter === 'paid') {
        filteredData = filteredData.filter(bill => bill.total === 0);
      } else if (totalPaymentFilter === 'unpaid') {
        filteredData = filteredData.filter(bill => bill.total > 0);
      }
      
      tbody.innerHTML = '';
      filteredData.forEach(bill => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${bill.electricity.current} ريال</td>
          <td>${bill.water.current} ريال</td>
          <td>${bill.rent.current} ريال</td>
          <td>${bill.month}</td>
          <td>${bill.electricity.overdue + bill.water.overdue + bill.rent.overdue} ريال</td>
          <td>${bill.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewIncomingBillDetails('${bill.id}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printIncomingBill('${bill.id}')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    

    // Toggle between sections
    function showSection(section) {
      document.getElementById('new-sale-section').style.display = 'none';
      document.getElementById('sales-table-section').style.display = 'none';
      document.getElementById('bills-table-section').style.display = 'none';
      document.getElementById(section).style.display = 'block';
    }
    document.addEventListener('DOMContentLoaded', function() {
      let newSaleOpen = false;
      const salesBtn = document.getElementById('show-sales-btn');
      const billsBtn = document.getElementById('show-bills-btn');
      const newSaleBtn = document.getElementById('new-sale-btn');
      const newSaleActionBtn = document.getElementById('new-sale-action-btn');

      newSaleBtn.onclick = function() {
        newSaleOpen = !newSaleOpen;
        if (newSaleOpen) {
          document.getElementById('new-sale-section').style.display = 'block';
          document.getElementById('sales-table-section').style.display = 'none';
          document.getElementById('bills-table-section').style.display = 'none';
          salesBtn.classList.remove('btn-blue', 'active');
          salesBtn.classList.add('btn-gray');
          billsBtn.classList.remove('btn-blue', 'active');
          billsBtn.classList.add('btn-gray');
        } else {
          document.getElementById('new-sale-section').style.display = 'none';
        }
      };
      salesBtn.onclick = function() {
        newSaleOpen = false;
        showSection('sales-table-section');
        salesBtn.classList.add('btn-blue', 'active');
        salesBtn.classList.remove('btn-gray');
        billsBtn.classList.remove('btn-blue', 'active');
        billsBtn.classList.add('btn-gray');
      };
      billsBtn.onclick = function() {
        newSaleOpen = false;
        showSection('bills-table-section');
        billsBtn.classList.add('btn-blue', 'active');
        billsBtn.classList.remove('btn-gray');
        salesBtn.classList.remove('btn-blue', 'active');
        salesBtn.classList.add('btn-gray');
      };
      // Show bills table by default
      billsBtn.classList.add('btn-blue', 'active');
      billsBtn.classList.remove('btn-gray');
      salesBtn.classList.remove('btn-blue', 'active');
      salesBtn.classList.add('btn-gray');
      showSection('bills-table-section');

      if (newSaleActionBtn) {
        newSaleActionBtn.onclick = function() {
          // إعادة تعيين النموذج وتوليد رقم وتاريخ جديد
          if (document.getElementById('new-sale-section').style.display === 'block') {
            openNewSaleForm();
          }
        };
      }
    });

    // تحديث قائمة الموظفين في الفلتر
    function fillSalesEmployeeFilter(filteredData) {
      const select = document.getElementById('sales-employee-filter');
      if (!select) return;
      // استخراج الموظفين من البيانات بدون تكرار
      const employees = [...new Set(filteredData.map(sale => sale.employee))];
      const current = select.value;
      select.innerHTML = '<option value="all">الكل</option>';
      employees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp;
        option.textContent = emp;
        select.appendChild(option);
      });
      // إعادة التحديد إذا كان موجوداً
      if (employees.includes(current)) select.value = current;
    }

    // تحميل بيانات المبيعات في الجدول مع الفلاتر
    function loadSalesData() {
      const tbody = document.getElementById('sales-table-body');
      const searchTerm = document.getElementById('sales-search').value.toLowerCase();
      const typeFilter = document.getElementById('sales-type-filter').value;
      const employeeFilter = document.getElementById('sales-employee-filter').value;
      const dateFilter = document.getElementById('sales-date-filter').value;
      
      let filteredData = sampleSalesData.filter(sale => {
        let match = true;
        if (searchTerm && !(
          sale.id.toLowerCase().includes(searchTerm) ||
          sale.employee.toLowerCase().includes(searchTerm) ||
          sale.type.toLowerCase().includes(searchTerm)
        )) match = false;
        if (typeFilter !== 'all' && sale.type !== typeFilter) match = false;
        if (employeeFilter !== 'all' && sale.employee !== employeeFilter) match = false;
        if (dateFilter && !sale.date.startsWith(dateFilter)) match = false;
        return match;
      });
      
      // عرض البيانات
      tbody.innerHTML = '';
      filteredData.forEach(sale => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sale.id}</td>
          <td>${sale.date}</td>
          <td>${sale.employee}</td>
          <td>${sale.products.length}</td>
          <td>${sale.type}</td>
          <td>${sale.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewSaleDetails('${sale.id}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printSale('${sale.id}')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
      fillSalesEmployeeFilter(filteredData);
    }

    // تحميل بيانات الفواتير مع الفلاتر
    function loadBillsData() {
      const tbody = document.getElementById('incoming-bills-table-body');
      const monthFilter = document.getElementById('bills-month-filter').value;
      const overdueFilter = document.getElementById('bills-overdue-filter').value;
      const totalPaymentFilter = document.getElementById('bills-total-payment-filter').value;
      
      let filteredData = sampleBillsData;
      if (monthFilter !== 'all') {
        filteredData = filteredData.filter(bill => bill.month.toLowerCase().includes(monthFilter));
      }
      if (overdueFilter === 'no') {
        filteredData = filteredData.filter(bill => (bill.electricity.overdue + bill.water.overdue + bill.rent.overdue) === 0);
      } else if (overdueFilter === 'yes') {
        filteredData = filteredData.filter(bill => (bill.electricity.overdue + bill.water.overdue + bill.rent.overdue) > 0);
      }
      
      // تطبيق فلتر الإجمالي المدفوع/غير المدفوع
      if (totalPaymentFilter === 'paid') {
        filteredData = filteredData.filter(bill => bill.status === 'مدفوعة');
      } else if (totalPaymentFilter === 'unpaid') {
        filteredData = filteredData.filter(bill => bill.status !== 'مدفوعة');
      }
      
      tbody.innerHTML = '';
      filteredData.forEach(bill => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${bill.electricity.current} ريال</td>
          <td>${bill.water.current} ريال</td>
          <td>${bill.rent.current} ريال</td>
          <td>${bill.month}</td>
          <td>${bill.electricity.overdue + bill.water.overdue + bill.rent.overdue} ريال</td>
          <td>${bill.total} ريال</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view-btn" onclick="viewIncomingBillDetails('${bill.id}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon print-btn" onclick="printIncomingBill('${bill.id}')" title="طباعة الفاتورة">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // إضافة مستمعي الأحداث
    document.addEventListener('DOMContentLoaded', function() {
      loadSalesData();
      loadBillsData();
      // سجل المبيعات
      document.getElementById('sales-search').addEventListener('input', loadSalesData);
      document.getElementById('sales-type-filter').addEventListener('change', loadSalesData);
      document.getElementById('sales-employee-filter').addEventListener('change', loadSalesData);
      document.getElementById('sales-date-filter').addEventListener('change', loadSalesData);
      // الفواتير
      document.getElementById('bills-month-filter').addEventListener('change', loadBillsData);
      document.getElementById('bills-overdue-filter').addEventListener('change', loadBillsData);
    });

    // تعبئة قائمة الأشهر ديناميكياً من بيانات الفواتير
    function fillBillsMonthFilter() {
      const select = document.getElementById('bills-month-filter');
      if (!select) return;
      const months = [...new Set(sampleBillsData.map(bill => bill.month))];
      select.innerHTML = '<option value="all">الكل</option>';
      months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        select.appendChild(option);
      });
    }

    // إضافة مستمعي الأحداث
    document.addEventListener('DOMContentLoaded', function() {
      loadSalesData();
      fillBillsMonthFilter();
      loadBillsData();
      // سجل المبيعات
      document.getElementById('sales-search').addEventListener('input', loadSalesData);
      document.getElementById('sales-type-filter').addEventListener('change', loadSalesData);
      document.getElementById('sales-employee-filter').addEventListener('change', loadSalesData);
      document.getElementById('sales-date-filter').addEventListener('change', loadSalesData);
      // الفواتير
      document.getElementById('bills-month-filter').addEventListener('change', loadBillsData);
      document.getElementById('bills-overdue-filter').addEventListener('change', loadBillsData);
      document.getElementById('bills-total-payment-filter').addEventListener('change', loadBillsData);
    });

    let originalProductsData = null;

    function toggleProductsEditMode() {
      const editColumn = document.querySelector('.edit-column');
      const editActions = document.getElementById('products-edit-actions');
      const isEditing = editColumn.style.display !== 'none';
      
      if (!isEditing) {
        // حفظ البيانات الأصلية
        originalProductsData = [...document.querySelectorAll('#sale-detail-products tr')].map(row => ({
          name: row.cells[0].textContent,
          barcode: row.cells[1].textContent,
          price: parseFloat(row.cells[2].textContent),
          quantity: parseInt(row.cells[3].textContent),
          total: parseFloat(row.cells[4].textContent)
        }));
        
        // تحويل الخلايا إلى حقول تعديل
        const rows = document.querySelectorAll('#sale-detail-products tr');
        rows.forEach(row => {
          const quantityCell = row.cells[3];
          const currentQuantity = quantityCell.textContent;
          quantityCell.innerHTML = `
            <input type="number" class="quantity-edit" value="${currentQuantity}" min="1" 
                   onchange="updateProductTotal(this)" data-price="${row.cells[2].textContent}">
          `;
          
          // إضافة زر حذف
          const actionsCell = document.createElement('td');
          actionsCell.className = 'edit-column';
          actionsCell.innerHTML = `
            <button class="btn-icon delete-btn" onclick="removeProductFromEdit(this)" title="حذف المنتج">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;
          row.appendChild(actionsCell);
        });
        
        editColumn.style.display = 'table-cell';
        editActions.style.display = 'flex';
      } else {
        cancelProductsEdit();
      }
    }

    function updateProductTotal(input) {
      const price = parseFloat(input.dataset.price);
      const quantity = parseInt(input.value);
      const total = price * quantity;
      const totalCell = input.closest('tr').cells[4];
      totalCell.textContent = `${total.toFixed(2)} ريال`;
    }

    function removeProductFromEdit(button) {
      button.closest('tr').remove();
    }

    function saveProductsChanges() {
      const rows = document.querySelectorAll('#sale-detail-products tr');
      const updatedProducts = Array.from(rows).map(row => ({
        name: row.cells[0].textContent,
        barcode: row.cells[1].textContent,
        price: parseFloat(row.cells[2].textContent),
        quantity: parseInt(row.querySelector('.quantity-edit').value),
        total: parseFloat(row.cells[4].textContent)
      }));
      
      // تحديث البيانات في مصفوفة المبيعات
      const saleId = document.getElementById('sale-detail-id').textContent;
      const saleIndex = sampleSalesData.findIndex(sale => sale.id === saleId);
      if (saleIndex !== -1) {
        sampleSalesData[saleIndex].products = updatedProducts;
        sampleSalesData[saleIndex].subtotal = updatedProducts.reduce((sum, product) => sum + product.total, 0);
        sampleSalesData[saleIndex].total = sampleSalesData[saleIndex].subtotal - 
                                         sampleSalesData[saleIndex].discount + 
                                         sampleSalesData[saleIndex].tax;
        
        // تحديث عرض التفاصيل
        viewSaleDetails(saleId);
        
        // تحديث جدول المبيعات
        loadSalesData();
      }
      
      // إغلاق وضع التعديل
      cancelProductsEdit();
    }

    function cancelProductsEdit() {
      const editColumn = document.querySelector('.edit-column');
      const editActions = document.getElementById('products-edit-actions');
      
      if (originalProductsData) {
        // إعادة عرض البيانات الأصلية
        const tbody = document.getElementById('sale-detail-products');
        tbody.innerHTML = '';
        originalProductsData.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.barcode}</td>
            <td>${product.price} ريال</td>
            <td>${product.quantity}</td>
            <td>${product.total} ريال</td>
          `;
          tbody.appendChild(row);
        });
      }
      
      editColumn.style.display = 'none';
      editActions.style.display = 'none';
      originalProductsData = null;
    }
  </script>
  <script src="../views/js/stores/index.js"> </script>  
</body>
</html>
